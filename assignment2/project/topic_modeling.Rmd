---
title: "R Notebook"
output: html_notebook
---

## adapted from TidyTextMining Ch 6

# TODO
* set `nr_of_topics` as Global variables
* sometimes setting `nr_of_topics` but not using it
* Try change plotting to loop maybe - changing the date?
* add title_suffix to all plots (need to decide how we're doing this to be consistent with the sentiment analysis too)

<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Setup -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->

```{r set colours}
# Stellenbosch branding manual colours:
# http://stbweb01.stb.sun.ac.za/centenarybrandtoolkit/SU_Brand_Manual_2019.pdf 
arts_orange <- "#FF8F1C"
law_winered <- "#9e2629"
theology_purple <- "#84329B"
education_darkblue <- "#326295"
agri_green <- "#509e2f"
med_bluegreen <- "#006163"
military_salmon <- "#e56a54"
science_red <- "#cb333b"
ems_lightblue <- "#2dccd3"
engineering_yellow <- "#eaaa00"
maroon <- "#60223b"
mustard <- "#F1B434"
darkgrey <- "#333333"
lightgrey <- "#8c979a"
black <- "#000000"

su_colors <- c(arts_orange, law_winered, theology_purple, education_darkblue, agri_green, med_bluegreen, military_salmon, science_red, ems_lightblue, engineering_yellow, maroon, mustard, darkgrey, lightgrey, black)

# microsoft sharepoint main colours
# https://docs.microsoft.com/en-us/sharepoint/dev/design/themes-colors
ms_red <- "#A4262C"
ms_orange <- "#CA5010"
ms_gold <- "#8F7034"
ms_green <- "#407855"
ms_teal <- "#038387"
ms_blue <- "#0078d4"
ms_darkblue <- "#40587C"
ms_indigo <- "#4052AB"
ms_plum <- "#854085"
ms_purple <- "#8764B8"
ms_coolgrey <- "#737373"
ms_warmgrey <- "#867365"

# ms_colors <- c(ms_red, ms_orange, ms_gold, ms_green, ms_teal, ms_blue, ms_darkblue, ms_indigo, ms_plum, ms_purple, ms_coolgrey, ms_warmgrey)
# ms_colors <- c(ms_darkblue, ms_red, ms_orange, ms_teal, ms_green, ms_blue, ms_indigo, ms_plum)
ms_colors <- c(ms_darkblue, ms_red, ms_orange, ms_teal, ms_gold, ms_coolgrey, ms_purple, ms_warmgrey, ms_green, ms_blue, ms_indigo, ms_plum)

# colour picker: http://tristen.ca/hcl-picker/#/hlc/10/1.02/EBB350/48231C
color_picker<- c("#EBB350", "#ABB14C", "#6EA85F", "#3A9976", "#248686", "#3F6F85", "#585674", "#623F57", "#5B2E37", "#48231C")

# palette generator: https://learnui.design/tools/data-color-picker.html#palette
palette_generator <- c("#003f5c", "#665191", "#d45087", "#ff7c43", "#ffa600")
```

```{r custom themes}
custom_column_basic_theme <- function () { 
    theme_minimal(base_size=12, base_family="Avenir") +
        theme(
            panel.background  = element_blank(),
            panel.grid.minor = element_blank(),
            legend.position="none", # no legend
            plot.title = element_text(size = 12, hjust = 0),
            axis.title.y = element_text(size = 10)
        )
}

custom_line_basic_theme <- function () { 
    theme_minimal(base_size=12, base_family="Avenir") +
        theme(
            panel.background  = element_blank(),
            panel.grid.minor = element_blank(),
            plot.title = element_text(size = 12, hjust = 0),
            plot.subtitle = element_text(size = 10, hjust = 0),
            axis.title.y = element_text(size = 10)
        )
}
```

```{r import libraries}
library(tidytext)
library(lubridate)
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)
library(topicmodels) # NOTE: (Gina) for Ubuntu need to install gsl package first with sudo apt-get install libgsl0-dev
library(ldatuning) # NOTE: (Gina) for Ubuntu needed to install (gmp package first with sudo apt-get install libgmp-dev) and (Rmpfr package with sudo apt-get install libmpfr-dev)

# Gina added
library(reshape2) # threw an error when assigning org_lda for not having this package
library(vader) # sentiment analysis
```
```{r global (static) variables}
SA_SUFFIX <- "-- South Africa"
GLOBAL_SUFFIX <- "-- Global"
SA_GOV_SUFFIX <- "-- SA Government"
```



```{r extract relevant data from read in csv}
extract_relevant_data <- function(df) {
  return(df %>% select(status_id, screen_name, name, location, description, created_at, statuses_count, is_retweet, favorite_count, retweet_count, followers_count, friends_count, text))
}
```

```{r read data}
# SA media organisations
SABCNews_tweets <- extract_relevant_data(read.csv("data/sabcnews.csv"))
DailyMav_tweets <- extract_relevant_data(read.csv("data/dailymaverick.csv"))
EWN_tweets <- extract_relevant_data(read.csv("data/ewnupdates.csv"))
News24_tweets <- extract_relevant_data(read.csv("data/news24.csv"))

SA_media_outlet_list <- list(DailyMav_tweets, EWN_tweets, News24_tweets, SABCNews_tweets)

head(SA_media_outlet_list[1])

# SA government
govZA_tweets <- extract_relevant_data(read.csv("data/governmentza.csv"))

# Global
nyTimes_tweets <- extract_relevant_data(read.csv("data/nytimes.csv"))
economist_tweets <- extract_relevant_data(read.csv("data/theeconomist.csv"))
bbcworld_tweets <- extract_relevant_data(read.csv("data/bbcworld.csv"))
AP_tweets <- extract_relevant_data(read.csv("data/ap.csv"))

global_media_outlet_list <- list(nyTimes_tweets, economist_tweets, bbcworld_tweets, AP_tweets)

head(global_media_outlet_list[1])
```
<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Data Wrangling -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->

```{r extract tweets related to covid and combine covid tweets into a list}
# extract covid tweets function
get_covid_tweets <- function(df) {
relevant_df <-  df[grepl("covid", df[["text"]]) | 
                  grepl("Covid", df[["text"]]) |
                  grepl("corona", df[["text"]]) |
                  grepl("Corona", df[["text"]]) |
                  grepl("Pandemic", df[["text"]]) |
                  grepl("pandemic", df[["text"]]), ]
relevant_df <- relevant_df %>%
  mutate(created_at = as.Date(created_at))
return(relevant_df)
}

# South African: combine relevant (Covid-related) tweets for all media outlets into list
covid_tweets_SA <- list(get_covid_tweets(DailyMav_tweets), 
                     get_covid_tweets(EWN_tweets), 
                     get_covid_tweets(News24_tweets), 
                     get_covid_tweets(SABCNews_tweets))

# SA government relevant (Covid-related) tweets
relevant_govZA <- get_covid_tweets(govZA_tweets)

# Global: combine relevant (Covid-related) tweets for all media outlets into list
covid_tweets_global <- list(get_covid_tweets(nyTimes_tweets), 
                            get_covid_tweets(AP_tweets),
                            get_covid_tweets(bbcworld_tweets), 
                            get_covid_tweets(economist_tweets))
```

```{r}
# combine all tweets into one dataframe
# Covid-related tweets
tweets_SA <- bind_rows(covid_tweets_SA)
tweets_global <- bind_rows(covid_tweets_global)
# all tweets
all_tweets_SA <- bind_rows(SA_media_outlet_list)
all_tweets_global <- bind_rows(global_media_outlet_list)
```

```{r media outlets}
SA_media_outlets <- unique(tweets_SA[c("name")])
global_media_outlets <- unique(tweets_global[c("name")])
```

```{r tidy tweets - remove stopwords and clean data}
clean_tweets <- function(tweets_in) {
  # define custom stopwords
  my_stopwords <- c("covid", "covid19", "corona", "coronavirus", "pandemic", "#sabcnews",
                    "maverick", "amp")
  # remove stopwords
  tidy_tweets <- tweets_in %>% 
    unnest_tokens(word, text, token = "tweets") %>%
    filter(!word %in% stop_words$word, # remove normal english stopwords
           # remove normal english stopwords that would contain ' that was lost by unnesting
           # eg "ain't" is a stopwords but wouldn't be recognised as such because it was converted to "aint"
           !word %in% str_remove_all(stop_words$word, "'"), # remove remaining normal stopwords
           !word %in% my_stopwords, # remove custom stopwords
           !str_starts(word, "http"), # remove links
           !str_starts(word, "@"), # remove mentions
           str_detect(word, "^[a-z#]*$")) %>% # remove special characters
    mutate(word = gsub("\\d+", "", word)) # remove numbers

  # change "vaccines" to "vaccine" so it is treated as the same word
  tidy_tweets["word"][tidy_tweets["word"] == "vaccines"] <- "vaccine"
  return(tidy_tweets)
}

tidy_tweets_SA <- clean_tweets(tweets_SA)
tidy_tweets_global <- clean_tweets(tweets_global)
tidy_tweets_govZA <- clean_tweets(relevant_govZA)
```

<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Topic Modeling Setup -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->

```{r extract top words per topic}
# topics arg: df containing word, topic and beta (probability that the word occurs in that topic) values
# words_per_topic: number of top words to get
top_words_per_topic <- function(topics, words_per_topic) {
  return(topics%>%
  group_by(topic) %>% # group words by topic
  slice_max(beta, n = words_per_topic) %>% # get most relevant words for that topic
  ungroup() %>%
  arrange(topic, -beta)) # arrange words with decreasing relevance to the topic
}
```

```{r global variables}
TOP_WORDS <- 10 # number of top words to show when plotting topics
TUNING <- FALSE # controls whether LDA tuning should be performed
```

```{r LDA tuning}
# to find uptimal number of topics to model for given document term matrix
# taken from: https://cran.r-project.org/web/packages/ldatuning/vignettes/topics.html
lda_tuning <- function(orgs_dtm) {
  result <- FindTopicsNumber(
      orgs_dtm,
      topics = seq(from = 2, to = 8, by = 1),
      metrics = c("Griffiths2004", "CaoJuan2009", "Arun2010", "Deveaud2014"),
      method = "Gibbs",
      control = list(seed = 77),
      mc.cores = 2L,
      verbose = TRUE
    )
  # choose extremum in following plots as optimal number of topics
  FindTopicsNumber_plot(result)
}
```

# Overall topics

```{r apply topic modelling to get overall topics}
overall_topics <- function(tidy_tweets_in, nr_of_topics) {
  # word count by media organisation
  word_counts <- tidy_tweets_in %>%
    select(name, word, created_at) %>%
    count(name, word, sort = TRUE) %>% # count how often each org uses each word
    ungroup()
  
  # create document term matrix from word count
  # (treating all tweets from one organisation as one document)
  orgs_dtm <- word_counts %>%
    cast_dtm(name, word, n)
  
  # checking for ideal number of topics
  # set to TRUE to run ldatuning
  if (TUNING) {
    lda_tuning(orgs_dtm)
  }
  
  # apply topic modelling to dtm
  # orgs_lda contains all the LDA output, incl alpha, beta, gamma values, terms, documents, wordassignments etc
  orgs_lda <- LDA(orgs_dtm, k = nr_of_topics, control = list(seed = 1234))
  
  # extract relevant data from the LDA output: topic, term, beta
  orgs_topics_overall <- tidy(orgs_lda, matrix = "beta") # beta = probability that a word is in each topic
  
  return(orgs_topics_overall)
}
```

```{r plot topics}
plot_overall_topics <- function(tidy_tweets_in, nr_of_topics, title_suffix) {
  # set plot colors
  plot_colors <- ms_colors
  if (title_suffix == "-- Global") {
    plot_colors <- rev(ms_colors)
  }
  
  # get the topics to plot
  orgs_topics <- overall_topics(tidy_tweets_in, nr_of_topics)
  
  # top words per topic
  top_terms <- top_words_per_topic(orgs_topics, TOP_WORDS)
  
  # plot top terms per topic
  top_terms %>%
    mutate(term = reorder_within(term, beta, topic)) %>% # reorder top terms to decreasing relevance
    ggplot(aes(beta, term, fill = factor(topic))) + # plot relevance of word for top words
    geom_col(show.legend = FALSE) +
    labs(title = paste("Covid-related Topics for Jan-June 2021"),
         subtitle = title_suffix) +
    facet_wrap(~ topic, scales = "free") + # plot for each topic
    scale_y_reordered() +
    scale_fill_manual(values = plot_colors) +
    custom_column_basic_theme()
}
```
 
# Overall Topics for Specific Month
 
```{r get topics per month}
monthly_topics <- function(tidy_tweets_in, past_month, nr_topics) {
  # word count by media organisation for specified month
  word_counts <- tidy_tweets_in %>%
    # create time bins (monthly)
    mutate(time_floor = floor_date(created_at, unit = "month")) %>%
    select(name, word, time_floor) %>%
    # filter to specified month
    filter(time_floor == as.Date(past_month)) %>%
    count(name, word, sort = TRUE) %>% # count how often each org uses each word
    ungroup()
    
  # create document term matrix from word count
  # (treating all tweets from one organisation as one document)
  orgs_dtm <- word_counts %>%
    cast_dtm(name, word, n)

  # checking for ideal number of topics
  # set to TRUE to run ldatuning
  if (TUNING) {
    lda_tuning(orgs_dtm)
  }
  
  # apply topic modelling to dtm
  # orgs_lda contains all the LDA output, incl alpha, beta, gamma values, terms, documents, wordassignments etc
  orgs_lda <- LDA(orgs_dtm, k = nr_topics, control = list(seed = 1234))

  # extract relevant data from the LDA output: topic, term, beta
  orgs_topics_month <- tidy(orgs_lda, matrix = "beta")
  
  return(orgs_topics_month)
}
```

```{r plot topics per month}
# past_month being the full date of the first day of that month - eg "2021-06-01" for June
plot_topics_of_month <- function(tidy_tweets_in, past_month, nr_topics, title_suffix) {
  # set plot colors
  plot_colors <- ms_colors
  if (title_suffix == "-- Global") {
    plot_colors <- rev(ms_colors)
  }

  # get the topics for the month to plot
  orgs_topics <- monthly_topics(tidy_tweets_in, past_month, nr_topics)

  # top words per topic
  top_terms <- top_words_per_topic(orgs_topics, TOP_WORDS)

  # plot top terms per topic
  top_terms %>%
    mutate(term = reorder_within(term, beta, topic)) %>% # reorder top terms to decreasing relevance
    ggplot(aes(beta, term, fill = factor(topic))) + # plot relevance of word for top words
    geom_col(show.legend = FALSE) +
    labs(title = paste("Covid-related Topics for month starting", past_month),
         subtitle = title_suffix) +
    facet_wrap(~ topic, scales = "free") + # plot for each topic
    scale_y_reordered() +
    scale_fill_manual(values = plot_colors) +
    custom_column_basic_theme()
}
```

 
# Topics for Specific Media Outlet

```{r get topics per organisation}
org_topics <- function(tidy_tweets_in, org, nr_topics) {
  # word count for specified media organisation
  word_counts <- tidy_tweets_in %>%
    select(name, word) %>%
    # filter to specified org
    filter(name == org) %>%
    count(name, word, sort = TRUE) %>% # count how often the org uses each word
    ungroup()
    
  # create document term matrix
  # (treating all tweets from one organisation as one document)
  orgs_dtm <- word_counts %>%
    cast_dtm(name, word, n)
  
  # checking for ideal number of topics
  # set to TRUE to run ldatuning
  if (TUNING) {
    lda_tuning(orgs_dtm)
  }

  # apply topic modelling to dtm
  # orgs_lda contains all the LDA output, incl alpha, beta, gamma values, terms, documents, wordassignments etc
  orgs_lda <- LDA(orgs_dtm, k = nr_topics, control = list(seed = 1234))

  # extract relevant data from the LDA output: topic, term, beta
  org_topics <- tidy(orgs_lda, matrix = "beta")
  
  return(org_topics)
}
```

```{r plot topics per organisation}
# org being the name of the media agency as found in the tidy_tweets dataframe
plot_topics_of_org <- function(tidy_tweets_in, org, nr_topics, title_suffix) {
  # set plot colors
  plot_colors <- ms_colors
  if (title_suffix == "-- Global") {
    plot_colors <- rev(ms_colors)
  }
  
  # get the topics for the org to plot
  orgs_topics <- org_topics(tidy_tweets_in, org, nr_topics)

  # apply topic modelling to dtm
  # orgs_lda contains all the LDA output, incl alpha, beta, gamma values, terms, documents, wordassignments etc
  top_terms <- top_words_per_topic(orgs_topics, TOP_WORDS)

  # plot top terms per topic
  top_terms %>%
    mutate(term = reorder_within(term, beta, topic)) %>% # reorder top terms to decreasing relevance
    ggplot(aes(beta, term, fill = factor(topic))) + # plot relevance of word for top words
    geom_col(show.legend = FALSE) +
    labs(title = paste("Covid-related Topics by", org),
         subtitle = title_suffix) +
    facet_wrap(~ topic, scales = "free") + # plot for each topic
    scale_y_reordered() +
    scale_fill_manual(values = plot_colors) +
    custom_column_basic_theme()
}
```


# Topics for specific Media Outlet for specific Month

```{r get topics per organisation per month}
monthly_org_topics <- function(tidy_tweets_in, org, past_month, nr_topics) {
  # word count for specified media organisation
  word_counts <- tidy_tweets_in %>%
    mutate(time_floor = floor_date(created_at, unit = "month")) %>%
    select(name, word, time_floor) %>%
    # filter to specified org
    filter(name == org) %>%
    # filter to specified month
    filter(time_floor == as.Date(past_month)) %>%
    count(name, word, sort = TRUE) %>% # count how often the org uses each word
    ungroup()
  
  if (length(word_counts$name) == 0) {
    print(paste(org, "did not tweet the month starting on", past_month))
    return()
  }
    
  # create document term matrix
  # (treating all tweets from one organisation as one document)
  orgs_dtm <- word_counts %>%
    cast_dtm(name, word, n)
  
  # checking for ideal number of topics
  # set to TRUE to run ldatuning
  if (TUNING) {
    lda_tuning(orgs_dtm)
  }

  # apply topic modelling to dtm
  # orgs_lda contains all the LDA output, incl alpha, beta, gamma values, terms, documents, wordassignments etc
  orgs_lda <- LDA(orgs_dtm, k = nr_topics, control = list(seed = 1234))

  # extract relevant data from the LDA output: topic, term, beta
  topics <- tidy(orgs_lda, matrix = "beta")
  return(topics)
}
```

```{r plot topics per organisation per month}
# org being the name of the media agency as found in the tidy_tweets dataframe
# past_month being the full date of the first day of that month - eg "2021-06-01" for June
plot_topics_of_org_for_month <- function(tidy_tweets_in, org, past_month, nr_topics, title_suffix) {
  # set plot colors
  plot_colors <- ms_colors
  if (title_suffix == "-- Global") {
    plot_colors <- rev(ms_colors)
  }
  
  # topics for org for month
  orgs_topics <- monthly_org_topics(tidy_tweets_in, org, past_month, nr_topics)
  if (is.null(orgs_topics)) {
    return()
  }
  
  # top words per topic
  top_terms <- top_words_per_topic(orgs_topics, TOP_WORDS)

  # plot top terms per topic
  top_terms %>%
    mutate(term = reorder_within(term, beta, topic)) %>% # reorder top terms to decreasing relevance
    ggplot(aes(beta, term, fill = factor(topic))) + # plot relevance of word for top words
    geom_col(show.legend = FALSE) +
    labs(title = paste("Covid-related Topics by", org, "for month starting", past_month),
         subtitle = title_suffix) +
    facet_wrap(~ topic, scales = "free") + # plot for each topic
    scale_y_reordered() +
    scale_fill_manual(values = plot_colors) +
    custom_column_basic_theme()
}
```


<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Data Visualisation -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->

# Overall topics

```{r}
# South Africa
nr_of_topics <- 5 # chosen based on ldatuning
plot_overall_topics(tidy_tweets_SA, nr_of_topics, SA_SUFFIX)
nr_of_topics <- 4 # chosen based on ldatuning
plot_overall_topics(tidy_tweets_govZA, nr_of_topics, SA_GOV_SUFFIX)
# Global
nr_of_topics <- 6 # chosen based on ldatuning
plot_overall_topics(tidy_tweets_global, nr_of_topics, GLOBAL_SUFFIX)
```

# Overall Topics for Specific Month

```{r}
# South Africa

# TODO: optimise somehow - for loop doesn't plot...?

nr_of_topics <- 4

plot_topics_of_month(tidy_tweets_SA, "2021-01-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_month(tidy_tweets_SA, "2021-02-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_month(tidy_tweets_SA, "2021-03-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_month(tidy_tweets_SA, "2021-04-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_month(tidy_tweets_SA, "2021-05-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_month(tidy_tweets_SA, "2021-06-01", nr_of_topics, SA_SUFFIX)
```

```{r}
# Global

# TODO: optimise somehow - for loop doesn't plot...?

nr_of_topics <- 4

plot_topics_of_month(tidy_tweets_global, "2021-01-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_month(tidy_tweets_global, "2021-02-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_month(tidy_tweets_global, "2021-03-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_month(tidy_tweets_global, "2021-04-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_month(tidy_tweets_global, "2021-05-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_month(tidy_tweets_global, "2021-06-01", nr_of_topics, GLOBAL_SUFFIX)
```


# Topics for Specific Media Outlet

```{r}
# South Africa

nr_of_topics <- 4

# TODO: optimise somehow - for loop doesn't plot...?
#for (outlet in SA_media_outlets$name) {
#  print(outlet)
#  plot_topics_of_org(tidy_tweets_SA, outlet, nr_of_topics)
#}

plot_topics_of_org(tidy_tweets_SA, "SABC News", nr_of_topics, SA_SUFFIX)
plot_topics_of_org(tidy_tweets_SA, "Daily Maverick", nr_of_topics, SA_SUFFIX)
plot_topics_of_org(tidy_tweets_SA, "Eyewitness News", nr_of_topics, SA_SUFFIX)
plot_topics_of_org(tidy_tweets_SA, "News24", nr_of_topics, SA_SUFFIX)
```

```{r}
# Global

nr_of_topics <- 3

# TODO: optimise somehow - for loop doesn't plot...?
#for (outlet in global_media_outlets$name) {
#  print(outlet)
#  plot_topics_of_org(tidy_tweets_global, outlet, nr_of_topics)
#}
plot_topics_of_org(tidy_tweets_global, "The New York Times", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org(tidy_tweets_global, "The Economist", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org(tidy_tweets_global, "BBC News (World)", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org(tidy_tweets_global, "The Associated Press", nr_of_topics, GLOBAL_SUFFIX)
```

# Topics for specific Media Outlet for specific Month

```{r}
# South Africa - January

# TODO: optimise somehow - for loop doesn't plot...?

nr_of_topics <- 3

plot_topics_of_org_for_month(tidy_tweets_SA, "SABC News", "2021-01-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "Daily Maverick", "2021-01-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "Eyewitness News", "2021-01-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "News24", "2021-01-01", nr_of_topics, SA_SUFFIX)
```

```{r}
# South Africa - Feb

nr_of_topics <- 3

plot_topics_of_org_for_month(tidy_tweets_SA, "SABC News", "2021-02-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "Daily Maverick", "2021-02-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "Eyewitness News", "2021-02-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "News24", "2021-02-01", nr_of_topics, SA_SUFFIX)
```

```{r}
# South Africa - March

nr_of_topics <- 3

plot_topics_of_org_for_month(tidy_tweets_SA, "SABC News", "2021-03-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "Daily Maverick", "2021-03-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "Eyewitness News", "2021-03-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "News24", "2021-03-01", nr_of_topics, SA_SUFFIX)
```

```{r}
# South Africa - April

nr_of_topics <- 3

plot_topics_of_org_for_month(tidy_tweets_SA, "SABC News", "2021-04-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "Daily Maverick", "2021-04-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "Eyewitness News", "2021-04-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "News24", "2021-04-01", nr_of_topics, SA_SUFFIX)
```

```{r}
# South Africa - May

nr_of_topics <- 3

plot_topics_of_org_for_month(tidy_tweets_SA, "SABC News", "2021-05-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "Daily Maverick", "2021-05-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "Eyewitness News", "2021-05-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "News24", "2021-05-01", nr_of_topics, SA_SUFFIX)
```

```{r}
# South Africa - June

nr_of_topics <- 3

plot_topics_of_org_for_month(tidy_tweets_SA, "SABC News", "2021-06-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "Daily Maverick", "2021-06-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "Eyewitness News", "2021-06-01", nr_of_topics, SA_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_SA, "News24", "2021-06-01", nr_of_topics, SA_SUFFIX)
```

```{r}
# Global - January
# TODO: optimise somehow - for loop doesn't plot...?

nr_of_topics <- 3

plot_topics_of_org_for_month(tidy_tweets_global, "The New York Times", "2021-01-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "The Economist", "2021-01-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "BBC News (World)", "2021-01-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "The Associated Press", "2021-01-01", nr_of_topics, GLOBAL_SUFFIX)
```

```{r}
# Global - Feb
nr_of_topics <- 3

plot_topics_of_org_for_month(tidy_tweets_global, "The New York Times", "2021-02-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "The Economist", "2021-02-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "BBC News (World)", "2021-02-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "The Associated Press", "2021-02-01", nr_of_topics, GLOBAL_SUFFIX)
```

```{r}
# Global - March
nr_of_topics <- 3

plot_topics_of_org_for_month(tidy_tweets_global, "The New York Times", "2021-03-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "The Economist", "2021-03-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "BBC News (World)", "2021-03-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "The Associated Press", "2021-03-01", nr_of_topics, GLOBAL_SUFFIX)
```

```{r}
# Global - April
nr_of_topics <- 3

plot_topics_of_org_for_month(tidy_tweets_global, "The New York Times", "2021-04-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "The Economist", "2021-04-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "BBC News (World)", "2021-04-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "The Associated Press", "2021-04-01", nr_of_topics, GLOBAL_SUFFIX)
```

```{r}
# Global - May
# TODO: graph label running over -> need to center differently (or change date to remove year)
nr_of_topics <- 3

plot_topics_of_org_for_month(tidy_tweets_global, "The New York Times", "2021-05-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "The Economist", "2021-05-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "BBC News (World)", "2021-05-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "The Associated Press", "2021-05-01", nr_of_topics, GLOBAL_SUFFIX)
```

```{r}
# Global - June
# TODO: graph label running over -> need to center differently (or change date to remove year)
nr_of_topics <- 3

plot_topics_of_org_for_month(tidy_tweets_global, "The New York Times", "2021-06-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "The Economist", "2021-06-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "BBC News (World)", "2021-06-01", nr_of_topics, GLOBAL_SUFFIX)
plot_topics_of_org_for_month(tidy_tweets_global, "The Associated Press", "2021-06-01", nr_of_topics, GLOBAL_SUFFIX)
```

```{r}
# TODO : SA government topics
```


<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Data Wrangling: Sentiment per topic -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->

# Sentiment per topic

```{r split topics into list of dataframes}
# split overall topics into a list with each dataframe only containing one topic and the term associated with it
words_per_topic <- 200
topics_overall <- top_words_per_topic(overall_topics(tidy_tweets_SA, nr_of_topics), words_per_topic)

term_per_topic_list <- topics_overall %>% 
  select(topic,term) %>% 
  group_split(topic)
term_per_topic_list
```
```{r Create list with topics per month}
NUM_TOPICS_MONTH <- 4
NUM_TOPICS_MONTH_REDUCED <- 2 # some months have less topics due to less data being available
words_per_topic <- 200

# TODO: Should indicate date on dataframe such that we know which month is associated with which dataframe in topics_per_month
# TODO: optimise this in some way with a loop?
topics_per_month_list <- list(
  top_words_per_topic(monthly_topics(tidy_tweets_SA, "2021-04-01", NUM_TOPICS_MONTH_REDUCED), words_per_topic),
  top_words_per_topic(monthly_topics(tidy_tweets_SA, "2021-05-01", NUM_TOPICS_MONTH), words_per_topic),
  top_words_per_topic(monthly_topics(tidy_tweets_SA, "2021-06-01", NUM_TOPICS_MONTH), words_per_topic)
)
topics_per_month_list
```


```{r Create list with topics per media outlet}
NUM_TOPICS_OUTLET <- 3
NUM_TOPICS_OUTLET_REDUCED <- 2

# TODO: Should indicate date on dataframe such that we know which month is associated with which dataframe in topics_per_outlet
# TODO: optimise this in some way with a loop?
topics_per_outlet_list <- list(
  top_words_per_topic(org_topics(tidy_tweets_SA, "Daily Maverick", NUM_TOPICS_OUTLET), words_per_topic),
  top_words_per_topic(org_topics(tidy_tweets_SA, "SABC News", NUM_TOPICS_OUTLET_REDUCED), words_per_topic),
  top_words_per_topic(org_topics(tidy_tweets_SA, "Eyewitness News", NUM_TOPICS_OUTLET_REDUCED), words_per_topic),
  top_words_per_topic(org_topics(tidy_tweets_SA, "News24", NUM_TOPICS_OUTLET_REDUCED), words_per_topic)
)
topics_per_outlet_list
```

```{r Create list with topics per media outlet per month}
# TODO: are we only doing June? -> add Jan
JUNE1 <- "2021-06-01"

# TODO: Should indicate date on dataframe such that we know which month is associated with which dataframe in topics_per_outlet_month_list
# TODO: optimise this in some way with a loop?
topics_per_outlet_month_list <- list(
  top_words_per_topic(monthly_org_topics(tidy_tweets_SA, "Daily Maverick", JUNE1, NUM_TOPICS_OUTLET), words_per_topic),
  top_words_per_topic(monthly_org_topics(tidy_tweets_SA, "SABC News", JUNE1, NUM_TOPICS_OUTLET), words_per_topic),
  top_words_per_topic(monthly_org_topics(tidy_tweets_SA, "Eyewitness News", JUNE1, NUM_TOPICS_OUTLET), words_per_topic),
  top_words_per_topic(monthly_org_topics(tidy_tweets_SA, "News24", JUNE1, NUM_TOPICS_OUTLET), words_per_topic)
)
topics_per_outlet_month_list
```


```{r apply vader sentiment analysis to list of topics on covid tweets}
# https://towardsdatascience.com/sentimental-analysis-using-vader-a3415fef7664
# all values greater than zeroes will be considered a positive review and all values less than zero would be considered as a negative review.
apply_vader <- function(df) {
  return(vader_df(df$term))
}

get_sentiment_mean <- function(df) {
  return(mean(df$compound))
}
```

```{r get topic sentiment mean per topic}
# TODO need to plot nicely (as table?)

# TODO: make sure this works for different topic amounts changed
# set names of topics
TOPIC <- list(paste0(1:length(term_per_topic_list)))

# get average sentiment
vader_analysis_per_topic <- lapply(term_per_topic_list, apply_vader)
sentiment_mean_per_topic <- unlist(lapply(vader_analysis_per_topic, get_sentiment_mean))

# get sentiment mean per topic
overall_sentiment_per_topic <- data.frame(TOPIC, sentiment_mean_per_topic)
colnames(overall_sentiment_per_topic)[1] = "topic"
overall_sentiment_per_topic
```

```{r get topic sentiment mean per month}
# TODO need to plot nicely (as table?)

# TODO update this - does not plor correctly (also need updating for new data)
# set months to plot
MONTHS_TO_PLOT <- c("April", "May", "June")

# get average sentiment
vader_analysis_per_month <- lapply(topics_per_month_list, apply_vader)
sentiment_mean_per_month <- unlist(lapply(vader_analysis_per_month, get_sentiment_mean))

# get sentiment mean per per month
overall_sentiment_per_month <- data.frame(month=MONTHS_TO_PLOT, sentiment_mean_per_month)
overall_sentiment_per_month
```
```{r set outlet names to plot}
# set outlet names to plot
OUTLETS_TO_PLOT <- c("Daily Maverick", "SABC News", "Eyewitness News", "News24")
```


```{r get topic sentiment mean per media outlet}
# TODO need to plot nicely (as table?)

# get average sentiment
vader_analysis_per_outlet <- lapply(topics_per_outlet_list, apply_vader)
sentiment_mean_per_outlet <- unlist(lapply(vader_analysis_per_outlet, get_sentiment_mean))

# get sentiment mean per per month
overall_sentiment_per_outlet <- data.frame(media_outlet=OUTLETS_TO_PLOT, sentiment_mean_per_outlet)
overall_sentiment_per_outlet
```
```{r get topic sentiment mean per media outlet per month}
# TODO need to plot nicely (as table?)

# get average sentiment
vader_analysis_per_outlet_month <- lapply(topics_per_outlet_month_list, apply_vader)
sentiment_mean_per_outlet_month <- unlist(lapply(vader_analysis_per_outlet_month, get_sentiment_mean))

# get sentiment mean per per month
overall_sentiment_per_outlet_month <- data.frame(media_outlet=OUTLETS_TO_PLOT, sentiment_mean_per_outlet_month)
overall_sentiment_per_outlet_month
```

<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Data Visualisation: Sentiment per topic -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->
# TODO: 
* plot global stuff too
* plot with new data stuff

```{r plot overall sentiment per topic on covid-19}
ggplot(overall_sentiment_per_topic, aes(topic, sentiment_mean_per_topic, fill=topic)) +
  geom_col() +
  labs(title = paste("Average sentiment per topic", "-- South Africa"),
       x="Topic",
       y="Vader Sentiment Score") +
  scale_fill_manual(values = ms_colors) +
  custom_column_basic_theme()
```
```{r plot overall sentiment per month on covid-19}
ggplot(overall_sentiment_per_month, aes(month, sentiment_mean_per_month, fill=month)) +
  geom_col() +
  labs(title = paste("Average sentiment per month", "-- South Africa"),
       x=NULL,
       y="Vader Sentiment Score") +
  scale_fill_manual(values = ms_colors) +
  custom_column_basic_theme()
```

```{r plot overall sentiment per outlet on covid-19}
ggplot(overall_sentiment_per_outlet, aes(media_outlet, sentiment_mean_per_outlet, fill=media_outlet)) +
  geom_col() +
  labs(title = paste("Average sentiment per media outlet", "-- South Africa"),
       x=NULL,
       y="Vader Sentiment Score") +
  scale_fill_manual(values = ms_colors) +
  custom_column_basic_theme()
```





```{r plot overall sentiment per outlet per month on covid-19}
ggplot(overall_sentiment_per_outlet_month, aes(media_outlet, sentiment_mean_per_outlet_month, fill=media_outlet)) +
  geom_col() +
  labs(title = paste("Monthly (June) sentiment per media outlet", "-- South Africa"),
       x=NULL,
       y="Vader Sentiment Score") +
  scale_fill_manual(values = ms_colors) +
  custom_column_basic_theme()
```