---
title: "Number of x"
output: html_notebook
---
# TODO
* combine all charts into one grouped bar chart (one for SA, one for global)
* label each column with number
* plot all and covid

<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Setup -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->

```{r set colours}
# Microsoft Sharepoint main colours
# https://docs.microsoft.com/en-us/sharepoint/dev/design/themes-colors
ms_red <- "#A4262C"
ms_orange <- "#CA5010"
ms_gold <- "#8F7034"
ms_green <- "#407855"
ms_teal <- "#038387"
ms_blue <- "#0078d4"
ms_darkblue <- "#40587C"
ms_indigo <- "#4052AB"
ms_plum <- "#854085"
ms_purple <- "#8764B8"
ms_coolgrey <- "#737373"
ms_warmgrey <- "#867365"

ms_colors <- c(ms_darkblue, ms_red, ms_orange, ms_teal, ms_gold, ms_coolgrey, ms_purple, ms_warmgrey, ms_green, ms_blue, ms_indigo, ms_plum)

# colour picker: http://tristen.ca/hcl-picker/#/hlc/10/1.02/EBB350/48231C
color_picker<- c("#EBB350", "#ABB14C", "#6EA85F", "#3A9976", "#248686", "#3F6F85", "#585674", "#623F57", "#5B2E37", "#48231C")

# palette generator: https://learnui.design/tools/data-color-picker.html#palette
palette_generator <- c("#003f5c", "#665191", "#d45087", "#ff7c43", "#ffa600")
```

```{r custom themes}
custom_column_basic_theme <- function () { 
    theme_minimal(base_size=12, base_family="Avenir") +
        theme(
            panel.background  = element_blank(),
            panel.grid.minor = element_blank(),
            legend.title = element_blank(), # no legend
            plot.title = element_text(size = 12, hjust = 0),
            plot.subtitle = element_text(size = 10, hjust = 0),
            axis.title.y = element_text(size = 10)
        )
}
```

```{r import libraries}
library(tidyverse)
library(scales)
library(ggplot2)
library(reshape2) # create multiple seties bar plot
```

```{r global (static) variables}
SA_SUFFIX <- "South Africa"
GLOBAL_SUFFIX <- "Global"
SA_GOV_SUFFIX <- "SA Government"
NUM_TWEETS <- 10 # number of (retweeted/favourited) tweets to be extracted
COVID <- "(Covid tweets)"
```

```{r extract relevant data from read in csv}
extract_relevant_data <- function(df) {
  return(df %>% select(status_id, name, created_at, statuses_count, favorite_count, retweet_count, followers_count, text))
}
```

```{r read South Africa data}
DailyMav_tweets <- extract_relevant_data(read.csv("data/dailymaverick.csv"))
EWN_tweets <- extract_relevant_data(read.csv("data/ewnupdates.csv"))
News24_tweets <- extract_relevant_data(read.csv("data/news24.csv"))
SABCNews_tweets <- extract_relevant_data(read.csv("data/sabcnews.csv"))
# combine tweets into a list of dataframes
media_outlet_list <- list(DailyMav_tweets, EWN_tweets, News24_tweets, SABCNews_tweets)

head(media_outlet_list[1])
```

```{r read Global data}
nytimes_tweets <- extract_relevant_data(read.csv("data/nytimes.csv"))
AP_tweets <- extract_relevant_data(read.csv("data/ap.csv"))
bbcworld_tweets <- extract_relevant_data(read.csv("data/bbcworld.csv"))
economist_tweets <- extract_relevant_data(read.csv("data/theeconomist.csv"))
# combine tweets into a list of dataframes
global_media_outlet_list <- list(nytimes_tweets, AP_tweets, bbcworld_tweets, economist_tweets)

head(global_media_outlet_list[1])
```
<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Data Wrangling -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->

```{r extract tweets related to covid and combine covid tweets into a list}
# extract covid tweets function
get_covid_tweets <- function(df) {
relevant_df <-  df[grepl("covid", df[["text"]]) | 
                  grepl("Covid", df[["text"]]) |
                  grepl("corona", df[["text"]]) |
                  grepl("Corona", df[["text"]]) |
                  grepl("Pandemic", df[["text"]]) |
                  grepl("pandemic", df[["text"]]), ]
relevant_df <- relevant_df %>%
  mutate(created_at = as.Date(created_at))
return(relevant_df)
}

# South Africa: combine relevant tweets for all media outlets into list
covid_tweets <- list(get_covid_tweets(DailyMav_tweets), 
                     get_covid_tweets(EWN_tweets), 
                     get_covid_tweets(News24_tweets), 
                     get_covid_tweets(SABCNews_tweets))

# Global: combine relevant tweets for all media outlets into list
global_covid_tweets <- list(get_covid_tweets(nytimes_tweets), 
                            get_covid_tweets(AP_tweets),
                            get_covid_tweets(bbcworld_tweets), 
                            get_covid_tweets(economist_tweets))
```

```{r get number of followers, tweets, and retweets per media outlet}
extract_number_of_x <- function(df_list) {
  extracted_list <- data.frame(name = unlist(lapply(df_list, function(df) {return(df$name[1])})),
                               followers_count = unlist(lapply(df_list, function(df) {return(df$followers_count[1])})),
                               tweets_count = unlist(lapply(df_list, function(df) {return(nrow(df))})),
                               retweet_count = unlist(lapply(df_list, function(df) {return(sum(df$retweet_count))})))
  return(extracted_list)
}
# total tweets per outlet
number_of_x <- extract_number_of_x(media_outlet_list)
global_number_of_x <- extract_number_of_x(global_media_outlet_list)

# covid tweets per outlet
covid_number_of_x <- extract_number_of_x(covid_tweets)
covid_global_number_of_x <- extract_number_of_x(global_covid_tweets)
```

```{r get top NUM_TWEETS retweeted/favourited tweets per media outlet}
get_top_count <- function(df, count_col) {
  text <- df %>%
    arrange(desc(count_col)) %>% 
    slice(1:NUM_TWEETS) %>% 
    select(status_id, name, created_at, names(count_col), text)
  return(text)
}
```

```{r South Africa: get top NUM_TWEETS retweets and favourited tweets}
# TODO need to plot nicely (as table?)
top_retweets <- lapply(media_outlet_list, function(df) {return(get_top_count(df, df$retweet_count))})
head(top_retweets)
top_favourited <- lapply(media_outlet_list, function(df) {return(get_top_count(df, df$favorite_count))})
head(top_favourited)
```

```{r Global: get top NUM_TWEETS retweets and favourited tweets}
# TODO need to plot nicely (as table?)
global_top_retweets <- lapply(global_media_outlet_list, function(df) {return(get_top_count(df, df$retweet_count))})
head(global_top_retweets)
global_top_favourited <- lapply(global_media_outlet_list, function(df) {return(get_top_count(df, df$favorite_count))})
head(global_top_favourited)
```


<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Data Visualisation (South African)-->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->

```{r plot number of tweets and retweets per media outlet}
plot_re_tweets <- function(df, title_suffix, covid_note) {
  # condense df such that multiple series bar plot can be plotted
  number_of_x_melted = melt(df %>% select(name, tweets_count, retweet_count), id.vars=c("name"))
  
  # set plot colors
  plot_colors <- c(ms_teal, ms_plum, ms_orange, ms_blue)
  if (title_suffix == GLOBAL_SUFFIX) {
    plot_colors <- rev(plot_colors)
  }
  
  ggplot(number_of_x_melted, aes(name, value, fill=variable)) +
    geom_bar(stat='Identity', position=position_dodge()) +
    labs(title = paste("Number of tweets and retweets per media outlet", covid_note),
         subtitle = title_suffix,
         x=NULL,
         y=NULL) +
    scale_y_continuous(labels = label_number(suffix = " M", scale = 1e-6)) +
    scale_fill_manual(values = rev(plot_colors)) +
    custom_column_basic_theme() +
    theme(legend.position = "right") +
    custom_column_basic_theme()
}
```
```{r}
plot_re_tweets(number_of_x, SA_SUFFIX, NULL)
plot_re_tweets(global_number_of_x, GLOBAL_SUFFIX, NULL)
```



```{r plot number of followers per media outlet}
plot_followers <- function(df, title_suffix, covid_note) {
  # set plot colors
  plot_colors <- ms_colors
  if (title_suffix == GLOBAL_SUFFIX) {
    plot_colors <- rev(ms_colors)
  }
  
  # plot
  ggplot(df, aes(name, followers_count, fill=name)) +
    geom_col() +
    labs(title = paste("Number of followers per media outlet", covid_note),
         subtitle = title_suffix,
         x=NULL,
         y=NULL) +
    scale_y_continuous(labels = label_number(suffix = " M", scale = 1e-6)) +
    scale_fill_manual(values = plot_colors) +
    custom_column_basic_theme()
}

plot_followers(number_of_x, SA_SUFFIX, NULL)
plot_followers(global_number_of_x, GLOBAL_SUFFIX, NULL)
```