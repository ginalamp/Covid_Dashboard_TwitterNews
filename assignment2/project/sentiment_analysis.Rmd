---
title: "Sentiment analysis"
output: html_notebook
---

# TODO
* add custom sentiment to vader analysis

<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Setup -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->

<!-- Set colours according to Stellenbosch Branding manual-->
<!-- http://stbweb01.stb.sun.ac.za/centenarybrandtoolkit/SU_Brand_Manual_2019.pdf -->
```{r set colours}
dailymav_colour <- "#FF8F1C" # Daily Maveric - arts_orange
capetalk_colour <- "#9e2629" # Cape Talk - law_winered
sabc_colour <- "#84329B" # SABC News - theology_purple
news24_colour <- "#326295" # News24 - education_darkblue
ewn_colour <- "#509e2f" # EWN - agri_green

# other colours to use
med_bluegreen <- "#006163"
military_salmon <- "#e56a54"
science_red <- "#cb333b"
ems_lightblue <- "#2dccd3"
maroon <- "#60223b"
mustard <- "#F1B434"
darkgrey <- "#333333"
lightgrey <- "#8c979a"
black <- "#000000"
engineering_yellow <- "#eaaa00"
```

```{r custom themes}
custom_column_basic_theme <- function () { 
    theme_minimal(base_size=12, base_family="Avenir") +
        theme(
            panel.background  = element_blank(),
            panel.grid.minor = element_blank(),
            legend.position="none", # no legend
            plot.title = element_text(size = 10, hjust = 0),
            plot.caption = element_text(size = 8, hjust = 0)
        )
}
```

```{r import libraries}
library(tidyverse)
library(vader) # sentiment analysis
library(tidytext)
library(lubridate) # date conversion
library(ggplot2)
```

```{r extract relevant data from read in csv}
extract_relevant_data <- function(df) {
  return(df %>% select(status_id, screen_name, created_at, statuses_count, is_retweet, favorite_count, retweet_count, followers_count, friends_count, text))
}
```

```{r read data}
# CapeTalk_tweets <- extract_relevant_data(read.csv("data/CapeTalk_tweets.csv"))
DailyMav_tweets <- extract_relevant_data(read.csv("data/DailyMav_tweets.csv"))
EWN_tweets <- extract_relevant_data(read.csv("data/EWN_tweets.csv"))
News24_tweets <- extract_relevant_data(read.csv("data/News24_tweets.csv"))
SABCNews_tweets <- extract_relevant_data(read.csv("data/SABCNews_tweets.csv"))
# media_outlet_list <- list(CapeTalk_tweets, DailyMav_tweets, EWN_tweets, News24_tweets, SABCNews_tweets)
media_outlet_list <- list(DailyMav_tweets, EWN_tweets, News24_tweets, SABCNews_tweets)

head(media_outlet_list[1])
```

<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Data Wrangling -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->


```{r extract tweets related to covid and combine covid tweets into a list}
# extract covid tweets function
get_covid_tweets <- function(df) {
relevant_df <-  df[grepl("covid", df[["text"]]) | 
                  grepl("Covid", df[["text"]]) |
                  grepl("corona", df[["text"]]) |
                  grepl("Corona", df[["text"]]) |
                  grepl("Pandemic", df[["text"]]) |
                  grepl("pandemic", df[["text"]]), ]
relevant_df <- relevant_df %>%
  mutate(created_at = ymd_hms(created_at))
return(relevant_df)
}

# call get_covid_tweets() function for all media outlets
# relevant_CapeTalk <- get_covid_tweets(CapeTalk_tweets)
relevant_DM <- get_covid_tweets(DailyMav_tweets)
relevant_EWN <- get_covid_tweets(EWN_tweets)
relevant_News24 <- get_covid_tweets(News24_tweets)
relevant_SABC <- get_covid_tweets(SABCNews_tweets)

# combine tweets into list
# covid_tweets <- list(relevant_CapeTalk, relevant_DM, relevant_EWN, relevant_News24, relevant_SABC)
covid_tweets <- list(relevant_DM, relevant_EWN, relevant_News24, relevant_SABC)
```

```{r tidy tweets - remove stopwords and clean data}
my_stopwords <- c("covid", "covid19", "corona", "coronavirus")

clean_tweets <- function(df) {
# remove stop words, links, special characters
cleaned_tweets <- df %>%
  unnest_tokens(word, text) %>%
  filter(!word %in% stop_words$word,
         !word %in% my_stopwords,
         !word %in% str_remove_all(stop_words$word, "'"),
         str_detect(word, "[a-z]")) %>%
  # group words back together (creating sentences) according to their twitter_id
  group_by(status_id, screen_name, created_at) %>%
  summarize(text=str_c(word, collapse = " ")) %>%
  ungroup()

return(cleaned_tweets)
}

# apply cleaning function to all media outlets
tidy_tweets <- lapply(covid_tweets, clean_tweets)
tidy_tweets
```

<!-- xx -->
<!-- ```{r remove stopwords and clean data} -->
<!-- # define custom stopwords -->
<!-- my_stopwords <- c("covid", "covid19", "corona", "coronavirus") -->

<!-- # remove stopwords, links, special chatacters -->
<!-- tidy_tweets <- relevant_CapeTalk %>% -->
<!--   unnest_tokens(word, text) %>% -->
<!--   filter(!word %in% stop_words$word, -->
<!--          !word %in% my_stopwords, -->
<!--          !word %in% str_remove_all(stop_words$word, "'"), -->
<!--          str_detect(word, "[a-z]")) %>% -->
<!--   # group words back together (creating sentences) according to their twitter_id -->
<!--   group_by(status_id) %>% -->
<!--   summarize(text=str_c(word, collapse = " ")) %>% -->
<!--   ungroup() -->
<!-- tidy_tweets -->
<!-- ``` -->

```{r apply vader sentiment analysis to list of cleaned covid tweets}
# https://towardsdatascience.com/sentimental-analysis-using-vader-a3415fef7664
# all values greater than zeroes will be considered a positive review and all values less than zero would be considered as a negative review.
apply_vader <- function(df) {
  return(vader_df(df$text))
}
vader_analysis <- lapply(tidy_tweets, apply_vader)
vader_analysis
```

<!-- x -->
<!-- ```{r vader sentiment analysis on dataframe} -->
<!-- # https://towardsdatascience.com/sentimental-analysis-using-vader-a3415fef7664 -->
<!-- # all values greater than zeroes will be considered a positive review and all values less than zero would be considered as a negative review. -->
<!-- vader_analysis <- vader_df(tidy_tweets$text) -->
<!-- vader_analysis -->
<!-- ``` -->

```{r}
name <- unlist(lapply(media_outlet_list, function(df) {return(df$screen_name[1])}))
name
```

```{r}
get_sentiment_mean <- function(df) {
  return(mean(df$compound))
}
# get average sentiment
sentiment_mean <- unlist(lapply(vader_analysis, get_sentiment_mean))
sentiment_mean
overall_sentiment_per_outlet <- data.frame(name, sentiment_mean)
overall_sentiment_per_outlet
```
<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Data Visualisation -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->


```{r plot overall sentiment per organisation on covid-19}
ggplot(overall_sentiment_per_outlet, aes(name, sentiment_mean, fill=name)) +
  geom_col() +
  labs(title = "Overall sentiment per organisation on covid-19",
       x=NULL,
       y=NULL) +
  scale_fill_manual(values = c(dailymav_colour, ewn_colour, news24_colour, sabc_colour)) +
  custom_column_basic_theme()
```
