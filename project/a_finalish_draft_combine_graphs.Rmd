---
title: "Final-ish Project Graphs"
author: "Johanna Engelhard and Gina Lamprecht"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    source_code: embed
    vertical_layout: scroll
  html_document:
    df_print: paged
---
# COVID-19 Dashboard
```{r import libraries}
library(tidyverse)
library(lubridate) # dates
library(chron) # reverse date plot
library(formattable) # round numbers
library(ggplot2)
library(scales) # add commas to axis
library(RcppRoll) # rolling average
library(flexdashboard) # html dashboard formatting
```

<!-- Custom themes -->
```{r}
custom_theme <- function () { 
    theme_minimal(base_size=12, base_family="Avenir") +
        theme(
            panel.background  = element_blank(),
            panel.grid.minor = element_blank(),
            legend.position="none", # no legend
            plot.title = element_text(size = 10, hjust = 0),
            plot.caption = element_text(size = 8, hjust = 0)
        )
}

custom_with_light_grid <- function () {
  theme_minimal(base_size=12, base_family="Avenir") +
  custom_theme() +
    theme (
      panel.grid.major.y = element_line(colour = "lightgrey"),
      panel.grid.major.x = element_blank()
    )
}

# with legend, horizontal grids
custom_line_theme <- function () { 
    theme_minimal(base_size=12, base_family="Avenir")
        theme(
            panel.background  = element_blank(),
            panel.grid.minor = element_blank(),
            plot.title = element_text(size = 10, hjust = 0),
            plot.caption = element_text(size = 8, hjust = 0)
        )
}
```

<!-- Set colours according to Stellenbosch Branding manual-->
<!-- http://stbweb01.stb.sun.ac.za/centenarybrandtoolkit/SU_Brand_Manual_2019.pdf -->
```{r set colours}
maroon <- "#60223b"
mustard <- "#F1B434"
darkgrey <- "#333333"
lightgrey <- "#8c979a"
black <- "#000000"
engineering_yellow <- "#eaaa00"
arts_orange <- "#FF8F1C" # active cases
military_salmon <- "#e56a54"
science_red <- "#cb333b"
law_winered <- "#9e2629" # deaths
theology_purple <- "#84329B" # confirmed cases
education_darkblue <- "#326295"
ems_lightblue <- "#2dccd3"
agri_green <- "#509e2f" # recovered / vaccinations
med_bluegreen <- "#006163"
```

```{r set data width}
data_width_standard <- 400
```


<!-- Read data -->
```{r read data}
# TODO: clean this up (remove duplicate data read ins)

# general (cumulative) information regarding tests, deaths, and recoveries. Complete timeline.
tests_deaths_recoveries_data <- read.csv("data/covid19za_timeline_testing.csv")

# total (cumulative) number of confirmed cases by province
provincial_total_confirmed <- read.csv("data/covid19za_provincial_cumulative_timeline_confirmed.csv")

# provincial deaths, and recoveries
provincial_recoveries_data<- read.csv("data/covid19za_provincial_cumulative_timeline_recoveries.csv")

# lockdown levels
national_lockdown<- read.csv("data/national_lockdown_govza.csv")

# death data
death_data <- read.csv("data/covid19za_provincial_cumulative_timeline_deaths.csv")

# populations per province
province_population <- read.csv("data/province_population.csv")

# owid SA extracted (big) data
owid_sa_data <- read.csv("data/owid-covid-data_SouthAfricaExtracted_big.csv")

# vaccinations data
vaccinations_data <- read.csv("data/covid19za_timeline_vaccination.csv")

# covid tests data
testing_data <- read.csv("data/covid19za_timeline_testing.csv")

# national hospital data
national_hospital_data <- read.csv("data/za_national_hospital_admissions.csv")
```

<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Wrangle data -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->
```{r value box death and recovered}
# total deaths
total_deaths <- max(tests_deaths_recoveries_data$deaths, na.rm = TRUE)

# get last day's number of deaths increase
last_death_cols <- tail(tests_deaths_recoveries_data$deaths, n=2)
death_day_update <- last_death_cols[2] - last_death_cols[1]

# total recovered
total_recovered <- max(tests_deaths_recoveries_data$recovered, na.rm = TRUE)

# percentage recovered
percentage_recovered <- total_recovered / (total_recovered + total_deaths) * 100
```

```{r value box active and confirmed cases}
# total confirmed cases
total_confirmed <- max(provincial_total_confirmed$total, na.rm = TRUE)

# get last day's number of confirmed increase
last_confirmed_cols <- tail(provincial_total_confirmed$total, n=2)
confirmed_day_update <- last_confirmed_cols[2] - last_confirmed_cols[1]

# active cases = confirmed cases  - recoveries - deaths
total_active <- total_confirmed - total_recovered - total_deaths
```

```{r value box tests}
# get number of tests
total_tests <- max(tests_deaths_recoveries_data$cumulative_tests, na.rm = TRUE)
# get last day's number of tests increase
last_tests_cols <- tail(tests_deaths_recoveries_data$cumulative_tests, n=2)
test_day_update <- last_tests_cols[2] - last_tests_cols[1]
```

```{r bar and line daily and total vaccinations}
# calculate daily vaccinations
vaccinations <- vaccinations_data %>%
  mutate(date = dmy(date)) %>%
  mutate(daily=vaccinations-lag(vaccinations,default=0)) %>% 
  mutate(total = vaccinations) %>%
  select(date, daily, total)
```

```{r bar daily deaths}
# calculate daily deaths
deaths_summary <- death_data %>%
  mutate(date = dmy(date)) %>%
  mutate(daily_deaths=total-lag(total,default=0)) %>%
  mutate(total_deaths = total) %>%
  select(date, daily_deaths, total_deaths)
```

```{r line faceted daily case trends}
cases <- provincial_total_confirmed %>% 
  pivot_longer(c('EC', 'FS', 'GP', 'KZN', 'LP', 'MP', 'NC', 'NW', 'WC', 'UNKNOWN'), 
               names_to = "province", values_to = "cases")
cases <- cases %>% 
  mutate(code = province) %>%
  select(date, code, cases, total)  %>% 
  filter(code != 'UNKNOWN') %>% 
  mutate(date = dmy(date)) %>%
  # calculate daily cases per province
  group_by(code) %>%
  mutate(daily_cases=cases-lag(cases,default=0)) %>%
  # calculate 7-day rolling average of daily cases
  mutate(rolling_avg = roll_mean(daily_cases, n=7, fill = NA, align = "right"))

cases_provincial <- cases %>%
  left_join(province_population, by = "code") %>%
  select(date, code, province, cases, daily_cases, rolling_avg, total)
cases_last_8_mths <- cases_provincial %>%
  filter(date >= ymd("2020-11-12"))
```

```{r bar deaths by province}
total_deaths_province <- tail(death_data, 1) %>% 
  pivot_longer(c('EC', 'FS', 'GP', 'KZN', 'LP', 'MP', 'NC', 'NW', 'WC', 'UNKNOWN'), 
               names_to = "province", values_to = "deaths")
total_deaths_province <- total_deaths_province %>% 
  select(date, province, deaths, total)  %>% 
  filter(province != 'UNKNOWN') %>% 
  mutate(date = dmy(date)) %>% 
  arrange(desc(deaths))

total_deaths_province$province <- factor(total_deaths_province$province, levels = total_deaths_province$province)
```

```{r bar deaths by province per 100k}
total_deaths_100k <- total_deaths_province %>%  
  mutate(code = province) %>%  # format so the column names are the same to be able to join the dataframes
  mutate(provincial_deaths = deaths) %>%
  select(!province) %>%
  select(!deaths)

# join dataframes so total_deaths includes province populations
total_deaths_100k <- total_deaths_100k %>%
  left_join(province_population, by = "code") 
# add deaths per 100k
total_deaths_100k <- total_deaths_100k %>%
  mutate(deaths_per_100k = round(100000 * provincial_deaths / population, digits=2)) %>%
  arrange(desc(provincial_deaths))

total_deaths_100k$province <- factor(total_deaths_100k$province, levels = total_deaths_100k$province)
total_deaths_100k$code <- factor(total_deaths_100k$code, levels = total_deaths_100k$code)

```

```{r bar provincial infections per 100k}
total_cases_100k <- tail(cases, 9) # cumulative cases per province up to 21 June 2021
# add province populations to province cases
total_cases_100k <- total_cases_100k %>%
  ungroup() %>%
  select(code, cases) %>%
  left_join(province_population, by = "code") %>% 
  select(code, province, cases, population) %>%
  # calculate infections per 100k population
  mutate(cases_per_100k = round(100000 * cases / population, digits=2)) %>% 
  arrange(cases_per_100k)

total_cases_100k$province <- factor(total_cases_100k$province, levels = total_cases_100k$province) # keep order when plotting
```

```{r avg daily tests per week}
testing <- testing_data %>%
  mutate(date = dmy(date)) %>%
  # calculate daily tests
  mutate(daily_tests=cumulative_tests-lag(cumulative_tests,default=0)) %>%
  mutate(week = week(date)) %>%
  select(date, week, daily_tests, cumulative_tests)

# add rolling average to the data
testing_avg <- testing %>%
  mutate(rolling_avg = roll_mean(daily_tests, n=7, fill = NA, align = "right")) %>%
  mutate(rolling_avg = round(rolling_avg)) %>%
# reduce data to start in April 2020 and include weekly average
  filter(date - ymd("2020-4-9") >= 0)

testing_avg <- testing_avg[c(TRUE, rep(FALSE, 6)),]
```

```{r bubble new tests and cases}
bubble_data <- owid_sa_data %>% 
  select(date, new_cases, new_tests) %>% 
  filter(!is.na(new_cases)) %>% 
  filter(!is.na(new_tests)) %>% 
  mutate(date = as.Date(date))
```

```{r last 20 days new cases}
# Get total confirmed cases per date
confirmed_20 <- owid_sa_data %>% 
  filter(!is.na(new_cases)) %>% 
  select(date, new_cases) %>% 
  mutate(date = as.Date(date)) %>% 
  filter(date > as.Date("2021-06-01"))
confirmed_20 <- confirmed_20 %>% map_df(rev) 
```

```{r daily confirmed cases with lockdown and 7-day average}
confirmed_lockdown <- provincial_total_confirmed %>% 
  select(date, total) %>% 
  mutate(date = dmy(date)) 

# get daily confirmed cases
confirmed_summary <- provincial_total_confirmed %>%
  select(date, total) %>%
  mutate(date = dmy(date)) %>%
  mutate(daily_confirmed=total-lag(total,default=0))
names(confirmed_summary)[names(confirmed_summary) == 'total'] <- 'total_confirmed'

# 7-day rolling average
confirmed_rolling_average <- confirmed_lockdown %>%
  mutate(daily_cases=total-lag(total,default=0)) %>%
  mutate(rolling_avg = roll_mean(daily_cases, n=7, fill = NA, align = "right"))

confirmed_summary <- confirmed_summary %>% 
  inner_join(confirmed_rolling_average, by = "date")

# lockdown levels
national_lockdown <- national_lockdown %>% 
  mutate(date_start = as.Date(date_start)) %>% 
  mutate(date_end = as.Date(date_end)) 

# lockdown segments
segment1 = data.frame(time = seq(national_lockdown$date_start[1], national_lockdown$date_end[1], by = "1 day"))
segment2 = data.frame(time = seq(national_lockdown$date_start[2], national_lockdown$date_end[2], by = "1 day"))
segment3 = data.frame(time = seq(national_lockdown$date_start[3], national_lockdown$date_end[3], by = "1 day"))
segment4 = data.frame(time = seq(national_lockdown$date_start[4], national_lockdown$date_end[4], by = "1 day"))
segment5 = data.frame(time = seq(national_lockdown$date_start[5], national_lockdown$date_end[5], by = "1 day"))
segment6 = data.frame(time = seq(national_lockdown$date_start[6], national_lockdown$date_end[6], by = "1 day"))
segment7 = data.frame(time = seq(national_lockdown$date_start[7], national_lockdown$date_end[7], by = "1 day"))
segment8 = data.frame(time = seq(national_lockdown$date_start[8], national_lockdown$date_end[8], by = "1 day"))
segment9 = data.frame(time = seq(national_lockdown$date_start[9], national_lockdown$date_end[9], by = "1 day"))
```

```{r active cases (confirmed, death and recovery data used)}
# recovery
recovery_summary <- tests_deaths_recoveries_data %>%
  select(date, recovered) %>%
  mutate(date = dmy(date)) %>%
  mutate(daily_recovered=recovered-lag(recovered,default=0))
names(recovery_summary)[names(recovery_summary) == 'recovered'] <- 'total_recovered'

# active
active_df <- recovery_summary %>% 
  inner_join(deaths_summary, by = "date") %>% 
  inner_join(confirmed_summary, by = "date")
active_df$total_active <- with(active_df, total_confirmed - total_deaths - total_recovered)

active_confirmed_summary <- active_df %>%
  select(date, total_active, total_confirmed, daily_confirmed, total_deaths, daily_deaths) %>%
  mutate(daily_active=total_active-lag(total_active,default=0))
```

```{r confirmed vs active per province (confirmed, death, recovery data used)}
# provincial deaths
# TODO: combine this with other death data
provincial_deaths <- death_data %>% pivot_longer(c('EC', 'FS', 'GP', 'KZN', 'LP', 'MP', 'NC', 'NW', 'WC', 'UNKNOWN'), names_to = "province", values_to = "deaths")
provincial_deaths <- provincial_deaths %>%
  select(date, province, deaths, total)  %>%
  filter(province != 'UNKNOWN') %>%
  mutate(date = dmy(date))

# provincial recoveries
provincial_recoveries <- provincial_recoveries_data %>% pivot_longer(c('EC', 'FS', 'GP', 'KZN', 'LP', 'MP', 'NC', 'NW', 'WC', 'UNKNOWN'), names_to = "province", values_to = "recoveries")
provincial_recoveries <- provincial_recoveries %>%
  group_by(province) %>%
  select(date, province, recoveries, total)  %>%
  filter(province != 'UNKNOWN') %>%
  mutate(date = dmy(date)) %>% 
  summarise(date = date, recoveries = recoveries)

# inner_join() joins based on matching keys (we only want overlapping dates)
provincial_active <- cases %>% 
  mutate(province = code) %>%
  inner_join(provincial_recoveries, by = c("province", "date")) %>% 
  inner_join(provincial_deaths, by = c("province", "date"))

# get active cases per province
provincial_active$active <- with(provincial_active, cases - recoveries - deaths)
provincial_active <- provincial_active %>%
  select(date, province, cases, recoveries, deaths, active)
# province_names <- c('EASTERN CAPE', 'FREE STATE','GAUTENG','KWAZULU NATAL', 'LIMPOPO', 'MPUMALANGA', 'NORTHERN CAPE', 'NORTH WEST', 'WESTERN CAPE')
# pn <- data.frame("province", province_names)
# provincial_active$province <- pn
head(provincial_active)
```

```{r national hospital data}
national_hospital_data <- national_hospital_data %>% 
  mutate(week_start = as.Date(week_start))
```


<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Plot data -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->
Row {data-width=400}
-----------------------------------------------------------------------

### confirmed cases {.value-box}

```{r plot confirmed cases box}
valueBox(
  value = paste(format(total_confirmed, big.mark = ","), " (+ ", confirmed_day_update,")", sep = ""),
  caption = "CONFIRMED CASES",
  icon = "fas fa-user-md",
  color = maroon
)
```



### total deaths {.value-box}

```{r plot total deaths box}
valueBox(
  value = paste(format(total_deaths, big.mark = ","), " (+ ", death_day_update,")", sep = ""),
  caption = "DEATHS",
  icon = "fas fa-user-md",
  color = science_red
)
```



### total tests {.value-box}

```{r plot total tests box}
valueBox(
  value = paste(format(total_tests, big.mark = ","), " (+ ", test_day_update,")", sep = ""),
  caption = "TESTS",
  icon = "fas fa-user-md",
  color = med_bluegreen
)
```

Row {data-width=400}
-------------------------------------
### active cases {.value-box}

```{r plot active cases box}
valueBox(
  value = paste(format(total_active, big.mark = ","), "", sep = " "),
  caption = "ACTIVE CASES",
  icon = "fas fa-user-md",
  color = mustard
)
```

### recovered {.value-box}

```{r plot recovered box}
valueBox(
  value = paste(format(total_recovered, big.mark = ","), " (", round(percentage_recovered, 1),"%)", sep = ""),
  caption = "RECOVERED",
  icon = "fas fa-user-md",
  color = agri_green
)
```

Row {data-width=400}
-------------------------------------
### **Daily vaccinations**
```{r}
# TODO: add dates to x axis
# TODO: add vaccinations for last 7 days to side of graph
ggplot(vaccinations, aes(date, daily)) + 
  geom_col() +
  scale_x_date(breaks = NULL) +
  scale_y_continuous(breaks=c(0, 50000, 100000), labels = comma, minor_breaks = NULL) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_theme()
```

<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Total vaccinations**
```{r}
# TODO: add dates to x axis
ggplot(vaccinations, aes(date, total)) + 
  geom_line() +
  scale_y_continuous(labels = comma, minor_breaks = NULL) +
  scale_x_date(breaks = NULL) + 
  geom_text(aes(label = total), data = tail(vaccinations, 1), nudge_y = 100000) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_theme()
```

Row {data-width=data_width_standard}
-------------------------------------
### **Daily confirmed cases**
```{r fig.width=10, fig.height=6}
# TODO: Format legend better

# lockdown level colours
# level_colours <- c("Level 1"="#bcbef5","Level 2"="#999ad1", "Level 3"= "#7476b5", "Level 4"="#444687", "Level 5"="#1e206e")
level_colours <- c("Level 1"=engineering_yellow,"Level 2"=arts_orange, "Level 3"= military_salmon, "Level 4"=science_red, "Level 5"=law_winered)

# plot
ggplot(confirmed_summary, aes(date)) +
  # lockdown segments
  geom_segment(data = segment1,
          aes(x = time, xend = time,
              y = 0, yend = Inf),
            show.legend = TRUE, colour=level_colours["Level 5"]) +
  geom_segment(data = segment2,
          aes(x = time, xend = time,
              y = 0, yend = Inf),
            show.legend = FALSE, colour=level_colours["Level 4"]) +
  geom_segment(data = segment3,
        aes(x = time, xend = time,
            y = 0, yend = Inf),
          show.legend = FALSE, colour=level_colours["Level 3"]) +
  geom_segment(data = segment4,
        aes(x = time, xend = time,
            y = 0, yend = Inf),
          show.legend = FALSE, colour=level_colours["Level 2"]) +
  geom_segment(data = segment5,
        aes(x = time, xend = time,
            y = 0, yend = Inf),
          show.legend = FALSE, colour=level_colours["Level 1"]) +
  geom_segment(data = segment6,
        aes(x = time, xend = time,
            y = 0, yend = Inf),
          show.legend = FALSE, colour=level_colours["Level 3"]) +
  geom_segment(data = segment7,
        aes(x = time, xend = time,
            y = 0, yend = Inf),
          show.legend = FALSE, colour=level_colours["Level 1"]) +
  geom_segment(data = segment8,
        aes(x = time, xend = time,
            y = 0, yend = Inf),
          show.legend = FALSE, colour=level_colours["Level 2"]) +
  geom_segment(data = segment9,
      aes(x = time, xend = time,
          y = 0, yend = Inf),
        show.legend = FALSE, colour=level_colours["Level 3"]) +
  # active cases and rolling average
  geom_col(aes(y = daily_confirmed), color = maroon) +
  geom_line(aes(y = rolling_avg), color = ems_lightblue, size=1) +
  labs(subtitle= "This chart shows the daily confirmed cases since March 2020. The levels refer to the lockdown levels. Blue line is the 7-day rolling average.",
     caption = "Updated: June 2021",
     x = NULL,
     y = NULL) +
  scale_colour_manual(name="Lockdown levels",values=level_colours) +
  # scale_fill_manual(name="Lockdown Levels", values=level_colours) + # manual legend
  scale_x_date(date_breaks = "1 month", date_labels = "%d %b") +
  scale_y_continuous(label=comma) +
  theme_minimal()
```


Row {data-width=data_width_standard}
-------------------------------------
### **Active case total by day**
```{r}
#TODO: Gap in active cases
ggplot(active_confirmed_summary, aes(date, total_active)) + 
  geom_col(color=arts_orange) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(label=comma, breaks = seq(0, 250000, by = 100000)) +
  custom_theme()
```


<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Daily deaths**
```{r}
ticks <- seq(as.Date("2020-04-01"), by="month", len=15)
ggplot(deaths_summary, aes(date, daily_deaths)) + 
  geom_col(fill = law_winered, color = law_winered) +
  scale_x_date(breaks = ticks, labels = paste("1", month(ticks, label = TRUE)), minor_breaks = NULL) + 
  scale_y_continuous(minor_breaks = NULL) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_theme() +
  theme(panel.grid.major.x = element_blank())

```

Row {data-width=data_width_standard}
-------------------------------------
### **Daily case trends**
```{r}
# TODO: replace province code with full province name
# TODO: add start and end date
ggplot(cases_last_8_mths, aes(date, rolling_avg)) + 
  geom_line(color = theology_purple) + 
  scale_y_continuous(labels = NULL, breaks = NULL) +
  scale_x_date(breaks = NULL) +
  facet_wrap(~ province, nrow = 2) +
  labs(subtitle= "UPDATED These charts show the seven-day average of daily new cases for the past eight months. The seven-day average is used to even out spikes in daily cases.",
       x = NULL,
       y = NULL)
```


Row {data-width=data_width_standard}
-------------------------------------
### **Cases vs Active Cases**
```{r fig.width=8}
# TODO: add total active and total confirmed number label
# TODO: Add legend with right colours labelling active and confirmed
# TODO: Gap in active cases
ggplot(active_confirmed_summary, aes(date)) + 
  geom_line(aes(y = total_confirmed), color=theology_purple) +
  geom_line(aes(y = total_active), color=arts_orange) + 
  labs(x = NULL,
     y = NULL,
     caption = "Updated: June 2021") +
  scale_colour_manual(name="",values="level_colours") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(label=comma) +
  custom_line_theme()
```

<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Total Deaths**
<!-- TODO insert here -->

<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Doubling Rates**
<!-- TODO insert here -->

Row {data-width=data_width_standard}
-------------------------------------
### **Deaths by Province**
```{r}
ggplot(total_deaths_province, aes(province, deaths)) + 
  geom_col(fill = law_winered) +
  geom_text(aes(label = deaths), vjust = -1) +
  scale_x_discrete() +
  scale_y_continuous(labels = NULL, breaks = NULL) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_theme() +
  theme(panel.grid.major.x = element_blank())
```


<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Deaths by Province (per 100k)**
```{r}
ggplot(total_deaths_100k, aes(code, deaths_per_100k)) + 
  geom_col(fill = law_winered) +
  geom_text(aes(label = deaths_per_100k), vjust = -1) +
  scale_x_discrete() +
  scale_y_continuous(labels = NULL, breaks = NULL) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_theme() +
  theme(panel.grid.major.x = element_blank())
```


<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Prov Infections per 100,000 Population**
```{r}
ggplot(total_cases_100k, aes(province, cases_per_100k)) + 
  geom_col(fill = theology_purple) +
  geom_text(aes(label = format(cases_per_100k, big.mark=",")), hjust = 0) +
  scale_x_discrete() +
  scale_y_continuous(labels = NULL) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  coord_flip() +
  custom_theme() +
  theme(panel.grid = element_blank())
```


Row {data-width=data_width_standard}
-------------------------------------
### **Confirmed and Active Cases by Province**
```{r fig.width=9}
# TODO: Add labels (total active and confirmed per province)
# TODO: Convert province codes to nice province names
ggplot(provincial_active, aes(date)) + 
  geom_line(aes(y = cases, colour = "Confirmed Cases"), color = theology_purple) + 
  geom_line(aes(y = active, colour = "Active Cases"), color = arts_orange) +
  scale_y_continuous(breaks = seq(0, 1000000, by = 1000000), limits = c(0, 5000000), labels = NULL) +
  scale_x_date(labels = NULL) +
  facet_wrap(~ province, nrow = 2) +
  labs(caption = "Updated: June 2021",
     x = NULL,
     y = NULL) +
  custom_line_theme()
```

Row {data-width=data_width_standard}
-------------------------------------
### **Average daily tests per week**
```{r}
# TODO: reverse dates, add labels and fix sizing

ggplot(testing_avg, aes(x = date, rolling_avg)) + 
  geom_col() +
  labs(caption = "Updated: June 2021",
       x = "Week",
       y = NULL) +
  #geom_text(aes(label = rolling_avg), hjust = 0) +
  scale_x_date(labels = NULL, breaks = NULL) +
  coord_flip() +  
  custom_theme() +
  theme(panel.grid = element_blank())
```

<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Average daily positives per week**
<!-- TODO insert here -->

<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **No of tests per positive case (weekly)**
<!-- TODO insert here -->

Row {data-width=data_width_standard}
-------------------------------------
### **Daily tests and positive cases**
```{r fig.width = 8}
# TODO: Add number of test labels on specific dates
# TODO: Y axis labeling (cap at 60k, but allow graph to continue upward)
ggplot(bubble_data, aes(x=date, y=new_tests, size = new_cases)) +
    geom_point(alpha=0.5, color=theology_purple) +
    scale_size(range = c(.1, 10)) +
    scale_x_date(date_breaks = "1 month", date_labels = "%d/%m") +
    scale_y_continuous(label=comma) +
    labs(title = "Number of tests per day",
         x = NULL, 
         y = NULL, 
         caption = element_text("Updated: June 2021")) +
    custom_with_light_grid()
```

Row {data-width=data_width_standard}
-------------------------------------
### **Confirmed infections (last 20 days)**
```{r fig.width=15}
# TODO: not plotting right (even when flipping the dates here - the date labels are wrong)
# TODO: theology_purple colour not showing
ggplot(confirmed_20, aes(x=rev(date), y=new_cases, fill=theology_purple)) + 
  geom_col(position="dodge", color=theology_purple) +
  geom_text(aes(label = new_cases), position = position_dodge(0.9), hjust=-0.1) + # add labels
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  scale_x_date(date_breaks = "1 day", date_labels = "%m-%d-%Y") +
  scale_y_continuous(labels = NULL, breaks = NULL)  + # remove unnecessary ticks
  coord_flip() +
  custom_theme()
```

Row {data-width=data_width_standard}
-------------------------------------
### **Positivity Rate: Number of Tests vs Positive Cases (%)**
<!-- TODO insert here -->

Row {data-width=data_width_standard}
-------------------------------------
### **National Hospital Admissions**
```{r fig.width=8}
# TODO: Add EPI week x axis label
# TODO: Flip Date x axis label to be at the top
ggplot(national_hospital_data, aes(week_start, total_national_hospital_admissions)) + 
  geom_line(color=med_bluegreen, size=1) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  # scale_x_date(date_breaks = "3 months", date_labels = "%b %Y") +
  coord_cartesian(ylim = c(0, 20000)) +
  scale_x_date(date_breaks = "2 months", date_labels = "%d %b") +
  scale_y_continuous(label=comma) +
  # theme(panel.grid.major.y = element_line(colour = "lightgrey")) + custom_theme()
  custom_with_light_grid()
```

<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Public vs. Private Tests**
<!-- TODO insert here -->

Row {data-width=data_width_standard}
-------------------------------------
### **Current Rt estimates for South Africa**
<!-- TODO insert here -->

Row {data-width=data_width_standard}
-------------------------------------
### **Excess Deaths (South Africa)**
<!-- TODO insert here -->

<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Excess Deaths (Provinces)**
<!-- TODO insert here -->


<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Excess Deaths (Metros)**
<!-- TODO insert here -->

Row {data-width=data_width_standard}
-------------------------------------
### **New daily confirmed Covid-19 cases: 7-day average**
<!-- TODO insert here -->


Row {data-width=200}
-------------------------------------
If you have any comments, suggestions or ideas, please feel free to contact us: ginalamp@sun.ac.za or 22098038@sun.ac.za


<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Other non-code stuff -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->
# Project Writeup
Explain overall code here

# Background Research

* Excess deaths
* Doubling rate

# Sources
* TODO


