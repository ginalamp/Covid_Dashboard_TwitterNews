---
title: "Final-ish Project Graphs"
author: "Johanna Engelhard and Gina Lamprecht"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    source_code: embed
    vertical_layout: scroll
  html_document:
    df_print: paged
---
# COVID-19 Dashboard
```{r import libraries}
library(tidyverse)
library(lubridate) # dates
library(chron) # reverse date plot
library(formattable) # round numbers
library(ggplot2)
library(scales) # add commas to axis
library(RcppRoll) # rolling average
library(flexdashboard) # html dashboard formatting
library(readxl)
library(gtable) # plot table
library(gridExtra) # plot table
library(grid) # plot table
```

<!-- Custom themes -->
```{r}
custom_theme <- function () { 
    theme_minimal(base_size=12, base_family="Avenir") +
        theme(
            panel.background  = element_blank(),
            panel.grid.minor = element_blank(),
            legend.position="none", # no legend
            plot.title = element_text(size = 10, hjust = 0),
            plot.caption = element_text(size = 8, hjust = 0)
        )
}

custom_with_light_grid <- function () {
  theme_minimal(base_size=12, base_family="Avenir") +
  custom_theme() +
    theme (
      panel.grid.major.y = element_line(colour = "lightgrey"),
      panel.grid.major.x = element_blank()
    )
}

# with legend, horizontal grids
custom_line_theme <- function () { 
    theme_minimal(base_size=12, base_family="Avenir")
        theme(
            panel.background  = element_blank(),
            panel.grid.minor = element_blank(),
            plot.title = element_text(size = 10, hjust = 0),
            plot.caption = element_text(size = 8, hjust = 0)
        )
}

# line with light grid and legend
custom_line_light_grid <- function () {
  theme_minimal(base_size=12, base_family="Avenir") +
    theme (
      panel.grid.major.y = element_line(colour = "lightgrey"),
      panel.grid.major.x = element_blank(),
      panel.background  = element_blank(),
      panel.grid.minor = element_blank(),
      plot.title = element_text(size = 10, hjust = 0),
      plot.caption = element_text(size = 8, hjust = 0),
      legend.title = element_blank() # remove legend title
    )
}
```

<!-- Set colours according to Stellenbosch Branding manual-->
<!-- http://stbweb01.stb.sun.ac.za/centenarybrandtoolkit/SU_Brand_Manual_2019.pdf -->
```{r set colours}
maroon <- "#60223b"
mustard <- "#F1B434"
darkgrey <- "#333333"
lightgrey <- "#8c979a"
black <- "#000000"
engineering_yellow <- "#eaaa00"
arts_orange <- "#FF8F1C" # active cases
military_salmon <- "#e56a54"
science_red <- "#cb333b"
law_winered <- "#9e2629" # deaths
theology_purple <- "#84329B" # confirmed cases
education_darkblue <- "#326295"
ems_lightblue <- "#2dccd3"
agri_green <- "#509e2f" # recovered / vaccinations
med_bluegreen <- "#006163"

# TODO: not working
# set default plotting default different colours
graph_colours <- options(
  ggplot2.discrete.color = list(c(maroon, mustard, arts_orange, law_winered, theology_purple, education_darkblue, agri_green, med_bluegreen))
)
```

```{r set data width}
data_width_standard <- 400
```


<!-- Read data -->
```{r read data}
# TODO: clean this up (remove duplicate data read ins)

# general (cumulative) information regarding tests, deaths, and recoveries. Complete timeline.
tests_deaths_recoveries_data <- read.csv("data/covid19za_timeline_testing.csv")

# total (cumulative) number of confirmed cases by province
provincial_total_confirmed <- read.csv("data/covid19za_provincial_cumulative_timeline_confirmed.csv")

# provincial deaths, and recoveries
provincial_recoveries_data<- read.csv("data/covid19za_provincial_cumulative_timeline_recoveries.csv")

# lockdown levels
national_lockdown<- read.csv("data/national_lockdown_govza.csv")

# death data
death_data <- read.csv("data/covid19za_provincial_cumulative_timeline_deaths.csv")

# populations per province
province_population <- read.csv("data/province_population.csv")

# owid SA extracted (big) data
owid_sa_data <- read.csv("data/owid-covid-data_SouthAfricaExtracted_big.csv")

# vaccinations data
vaccinations_data <- read.csv("data/covid19za_timeline_vaccination.csv")

# covid tests data
testing_data <- read.csv("data/covid19za_timeline_testing.csv")

# national hospital data
national_hospital_data <- read.csv("data/za_national_hospital_admissions.csv")

# reproduction rate data
rt_data <- read.csv("data/calculated_rt_sa_provincial_cumulative.csv")

# weekly excess deaths per province 
excess_deaths_provinces_data <- read_xlsx("data/weekly_excess_deaths_provinces.xlsx")

# weekly excess deaths per metro 
excess_deahts_metros_data <- read_xlsx("data/weekly_excess_deaths_metros.xlsx")

# continental data containing confirmed cases for each country and continent
continent_data <- read.csv("data/new_cases_world.csv")
```

<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Wrangle data -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->
```{r value box death and recovered}
# total deaths
total_deaths <- max(tests_deaths_recoveries_data$deaths, na.rm = TRUE)

# get last day's number of deaths increase
last_death_cols <- tail(tests_deaths_recoveries_data$deaths, n=2)
death_day_update <- last_death_cols[2] - last_death_cols[1]

# total recovered
total_recovered <- max(tests_deaths_recoveries_data$recovered, na.rm = TRUE)

# percentage recovered
percentage_recovered <- total_recovered / (total_recovered + total_deaths) * 100
```

```{r value box active and confirmed cases}
# total confirmed cases
total_confirmed <- max(provincial_total_confirmed$total, na.rm = TRUE)

# get last day's number of confirmed increase
last_confirmed_cols <- tail(provincial_total_confirmed$total, n=2)
confirmed_day_update <- last_confirmed_cols[2] - last_confirmed_cols[1]

# active cases = confirmed cases  - recoveries - deaths
total_active <- total_confirmed - total_recovered - total_deaths
```

```{r value box tests}
# get number of tests
total_tests <- max(tests_deaths_recoveries_data$cumulative_tests, na.rm = TRUE)
# get last day's number of tests increase
last_tests_cols <- tail(tests_deaths_recoveries_data$cumulative_tests, n=2)
test_day_update <- last_tests_cols[2] - last_tests_cols[1]
```

```{r bar and line daily and total vaccinations}
# calculate daily vaccinations
vaccinations <- vaccinations_data %>%
  mutate(date = dmy(date)) %>%
  mutate(daily=vaccinations-lag(vaccinations,default=0)) %>% 
  mutate(total = vaccinations) %>%
  select(date, daily, total)
```

```{r bar daily deaths}
# calculate daily deaths
deaths_summary <- death_data %>%
  mutate(date = dmy(date)) %>%
  mutate(daily_deaths=total-lag(total,default=0)) %>%
  mutate(total_deaths = total) %>%
  select(date, daily_deaths, total_deaths)
```

```{r line faceted daily case trends}
cases <- provincial_total_confirmed %>% 
  pivot_longer(c('EC', 'FS', 'GP', 'KZN', 'LP', 'MP', 'NC', 'NW', 'WC', 'UNKNOWN'), 
               names_to = "province", values_to = "cases")
cases <- cases %>% 
  mutate(code = province) %>%
  select(date, code, cases, total)  %>% 
  filter(code != 'UNKNOWN') %>% 
  mutate(date = dmy(date)) %>%
  # calculate daily cases per province
  group_by(code) %>%
  mutate(daily_cases=cases-lag(cases,default=0)) %>%
  # calculate 7-day rolling average of daily cases
  mutate(rolling_avg = roll_mean(daily_cases, n=7, fill = NA, align = "right"))

cases_provincial <- cases %>%
  left_join(province_population, by = "code") %>%
  select(date, code, province, cases, daily_cases, rolling_avg, total)
cases_last_8_mths <- cases_provincial %>%
  filter(date >= ymd("2020-11-12"))
```

```{r bar deaths by province}
total_deaths_province <- tail(death_data, 1) %>% 
  pivot_longer(c('EC', 'FS', 'GP', 'KZN', 'LP', 'MP', 'NC', 'NW', 'WC', 'UNKNOWN'), 
               names_to = "province", values_to = "deaths")
total_deaths_province <- total_deaths_province %>% 
  select(date, province, deaths, total)  %>% 
  filter(province != 'UNKNOWN') %>% 
  mutate(date = dmy(date)) %>% 
  arrange(desc(deaths))

total_deaths_province$province <- factor(total_deaths_province$province, levels = total_deaths_province$province)
```

```{r bar deaths by province per 100k}
total_deaths_100k <- total_deaths_province %>%  
  mutate(code = province) %>%  # format so the column names are the same to be able to join the dataframes
  mutate(provincial_deaths = deaths) %>%
  select(!province) %>%
  select(!deaths)

# join dataframes so total_deaths includes province populations
total_deaths_100k <- total_deaths_100k %>%
  left_join(province_population, by = "code") 
# add deaths per 100k
total_deaths_100k <- total_deaths_100k %>%
  mutate(deaths_per_100k = round(100000 * provincial_deaths / population, digits=2)) %>%
  arrange(desc(provincial_deaths))

total_deaths_100k$province <- factor(total_deaths_100k$province, levels = total_deaths_100k$province)
total_deaths_100k$code <- factor(total_deaths_100k$code, levels = total_deaths_100k$code)

```

```{r bar provincial infections per 100k}
total_cases_100k <- tail(cases, 9) # cumulative cases per province up to 21 June 2021
# add province populations to province cases
total_cases_100k <- total_cases_100k %>%
  ungroup() %>%
  select(code, cases) %>%
  left_join(province_population, by = "code") %>% 
  select(code, province, cases, population) %>%
  # calculate infections per 100k population
  mutate(cases_per_100k = round(100000 * cases / population, digits=2)) %>% 
  arrange(cases_per_100k)

total_cases_100k$province <- factor(total_cases_100k$province, levels = total_cases_100k$province) # keep order when plotting
```

```{r avg daily tests per week}
testing <- testing_data %>%
  mutate(date = dmy(date)) %>%
  # calculate daily tests
  mutate(daily_tests=cumulative_tests-lag(cumulative_tests,default=0)) %>%
  mutate(week = week(date)) %>%
  select(date, week, daily_tests, cumulative_tests)

# add rolling average to the data
testing_avg <- testing %>%
  mutate(rolling_avg = roll_mean(daily_tests, n=7, fill = NA, align = "right")) %>%
  mutate(rolling_avg = round(rolling_avg)) %>%
# reduce data to start in April 2020 and include weekly average
  filter(date - ymd("2020-4-9") >= 0)

testing_avg <- testing_avg %>%
  filter(as.numeric(date - ymd("2020-4-9")) %% 7 == 0)
```

```{r avg daily positives per week}
daily_cases <- provincial_total_confirmed %>%
  mutate(date = dmy(date)) %>%
  mutate(total_cases = total) %>%
  select(date, total_cases) %>%
  mutate(daily_cases=total_cases-lag(total_cases,default=0))

# add rolling average to the data
daily_cases_avg <- daily_cases %>%
  mutate(rolling_avg = roll_mean(daily_cases, n=7, fill = NA, align = "right")) %>%
  mutate(rolling_avg = round(rolling_avg))
  
# reduce data to start in April 2020 and include weekly average
weekly_avg_daily_cases <- daily_cases_avg %>%
  filter(date - ymd("2020-4-9") >= 0)

weekly_avg_daily_cases <- weekly_avg_daily_cases %>%
  filter(as.numeric(date - ymd("2020-4-9")) %% 7 == 0)
```

```{r num tests per positive case weekly}
testing_avg <- testing_avg %>%
  mutate(testing_rolling_avg = rolling_avg)
weekly_avg_daily_cases <- weekly_avg_daily_cases %>%
  mutate(confirmed_rolling_avg = rolling_avg)

tests_per_positive <- testing_avg %>% 
  inner_join(weekly_avg_daily_cases, by="date") %>% 
  select(date, testing_rolling_avg, confirmed_rolling_avg)
# %>%   drop_na(date, testing_rolling_avg, confirmed_rolling_avg) # avg daily test per week has NA at start
tests_per_positive$ratio <- with(tests_per_positive, testing_rolling_avg / confirmed_rolling_avg)
```

```{r bubble new tests and cases}
bubble_data <- owid_sa_data %>% 
  select(date, new_cases, new_tests) %>% 
  filter(!is.na(new_cases)) %>% 
  filter(!is.na(new_tests)) %>% 
  mutate(date = as.Date(date))
```

```{r last 20 days new cases}
# Get total confirmed cases per date
confirmed_20 <- owid_sa_data %>% 
  filter(!is.na(new_cases)) %>% 
  select(date, new_cases) %>% 
  mutate(date = as.Date(date)) %>% 
  filter(date > as.Date("2021-06-01"))
confirmed_20 <- confirmed_20 %>% map_df(rev) 
```

```{r daily confirmed cases with lockdown and 7-day average}
confirmed_lockdown <- provincial_total_confirmed %>% 
  select(date, total) %>% 
  mutate(date = dmy(date)) 

# get daily confirmed cases
confirmed_summary <- provincial_total_confirmed %>%
  select(date, total) %>%
  mutate(date = dmy(date)) %>%
  mutate(daily_confirmed=total-lag(total,default=0))
names(confirmed_summary)[names(confirmed_summary) == 'total'] <- 'total_confirmed'

# 7-day rolling average
confirmed_rolling_average <- confirmed_lockdown %>%
  mutate(daily_cases=total-lag(total,default=0)) %>%
  mutate(rolling_avg = roll_mean(daily_cases, n=7, fill = NA, align = "right"))

confirmed_summary <- confirmed_summary %>% 
  inner_join(confirmed_rolling_average, by = "date")

# lockdown levels
national_lockdown <- national_lockdown %>% 
  mutate(date_start = as.Date(date_start)) %>% 
  mutate(date_end = as.Date(date_end)) 

# lockdown segments
segment1 = data.frame(time = seq(national_lockdown$date_start[1], national_lockdown$date_end[1], by = "1 day"))
segment2 = data.frame(time = seq(national_lockdown$date_start[2], national_lockdown$date_end[2], by = "1 day"))
segment3 = data.frame(time = seq(national_lockdown$date_start[3], national_lockdown$date_end[3], by = "1 day"))
segment4 = data.frame(time = seq(national_lockdown$date_start[4], national_lockdown$date_end[4], by = "1 day"))
segment5 = data.frame(time = seq(national_lockdown$date_start[5], national_lockdown$date_end[5], by = "1 day"))
segment6 = data.frame(time = seq(national_lockdown$date_start[6], national_lockdown$date_end[6], by = "1 day"))
segment7 = data.frame(time = seq(national_lockdown$date_start[7], national_lockdown$date_end[7], by = "1 day"))
segment8 = data.frame(time = seq(national_lockdown$date_start[8], national_lockdown$date_end[8], by = "1 day"))
segment9 = data.frame(time = seq(national_lockdown$date_start[9], national_lockdown$date_end[9], by = "1 day"))
```

```{r active cases (confirmed, death and recovery data used)}
# recovery
recovery_summary <- tests_deaths_recoveries_data %>%
  select(date, recovered) %>%
  mutate(date = dmy(date)) %>%
  mutate(daily_recovered=recovered-lag(recovered,default=0))
names(recovery_summary)[names(recovery_summary) == 'recovered'] <- 'total_recovered'

# active
active_df <- recovery_summary %>% 
  inner_join(deaths_summary, by = "date") %>% 
  inner_join(confirmed_summary, by = "date")
active_df$total_active <- with(active_df, total_confirmed - total_deaths - total_recovered)

active_confirmed_summary <- active_df %>%
  select(date, total_active, total_confirmed, daily_confirmed, total_deaths, daily_deaths) %>%
  mutate(daily_active=total_active-lag(total_active,default=0))
```

```{r confirmed vs active per province (confirmed, death, recovery data used)}
# provincial deaths
# TODO: combine this with other death data
provincial_deaths <- death_data %>% pivot_longer(c('EC', 'FS', 'GP', 'KZN', 'LP', 'MP', 'NC', 'NW', 'WC', 'UNKNOWN'), names_to = "province", values_to = "deaths")
provincial_deaths <- provincial_deaths %>%
  select(date, province, deaths, total)  %>%
  filter(province != 'UNKNOWN') %>%
  mutate(date = dmy(date))

# provincial recoveries
provincial_recoveries <- provincial_recoveries_data %>% pivot_longer(c('EC', 'FS', 'GP', 'KZN', 'LP', 'MP', 'NC', 'NW', 'WC', 'UNKNOWN'), names_to = "province", values_to = "recoveries")
provincial_recoveries <- provincial_recoveries %>%
  group_by(province) %>%
  select(date, province, recoveries, total)  %>%
  filter(province != 'UNKNOWN') %>%
  mutate(date = dmy(date)) %>% 
  summarise(date = date, recoveries = recoveries)

# inner_join() joins based on matching keys (we only want overlapping dates)
provincial_active <- cases %>% 
  mutate(province = code) %>%
  inner_join(provincial_recoveries, by = c("province", "date")) %>% 
  inner_join(provincial_deaths, by = c("province", "date"))

# get active cases per province
provincial_active$active <- with(provincial_active, cases - recoveries - deaths)
provincial_active <- provincial_active %>%
  select(date, province, cases, recoveries, deaths, active)

# attempt to replace names with "nicer" names - problem with grouping
# province_names <- c('EASTERN CAPE', 'FREE STATE','GAUTENG','KWAZULU NATAL', 'LIMPOPO', 'MPUMALANGA', 'NORTHERN CAPE', 'NORTH WEST', 'WESTERN CAPE')
# pn <- data.frame("province", province_names)
# provincial_active$province <- pn
# head(provincial_active)
```

```{r national hospital admissions}
national_hospital_data <- national_hospital_data %>% 
  mutate(week_start = as.Date(week_start))
```

```{r reproduction estimates for south africa }
rt_summary <- rt_data %>%
  select(state, date, ML) %>%
  mutate(date = as.Date(date)) %>%
  filter(state=="Total RSA")

rolling_avg_rt <- rt_summary %>%
  mutate(rolling_avg = roll_mean(ML, n=7, fill = NA, align = "right"))

rt_summary <- rt_summary %>% 
  inner_join(rolling_avg_rt, by = "date")
```

```{r excess deaths (south africa)}
excess_deaths_provinces_data <- excess_deaths_provinces_data %>%
  mutate(date = ymd(date))

# look at the three time intervals
may3_june5 <- excess_deaths_provinces_data %>%
  filter(date <= ymd("2021-06-05")) %>%
  select(date, RSA)

may3_june12 <- excess_deaths_provinces_data %>%
  filter(date <= ymd("2021-06-12")) %>%
  select(date, RSA)

may3_june19 <- excess_deaths_provinces_data %>%
  filter(date <= ymd("2021-06-19")) %>%
  select(date, RSA)

# excess deaths for given time periods
interval1 <- sum(may3_june5$RSA)
interval2 <- sum(may3_june12$RSA)
interval3 <- sum(may3_june19$RSA)
interval <- c(round(interval1), round(interval2), round(interval3))

period <- c("3 May-5 June", "3 May-12 June", "3 May-19 June")
date <- c(ymd("2021-06-05"), ymd("2021-06-12"), ymd("2021-06-19"))

# excess deaths (south africa)
excess_deaths_SA <- data.frame(date, period, interval) %>%
  mutate(total_deaths = interval) %>%
  select(date, period, total_deaths)

# covid deaths (south africa)
covid_deaths_SA <- death_data %>%
  mutate(date = dmy(date)) %>%
  mutate(covid_deaths = total) %>%
  select(date, covid_deaths) %>%
  filter(date %in% c(ymd("2021-06-05"), ymd("2021-06-12"), ymd("2021-06-19")))

# join excess deaths and covid deaths
deaths_SA <- excess_deaths_SA %>%
  left_join(covid_deaths_SA, by = "date")

deaths_SA$period <- factor(deaths_SA$period, levels = deaths_SA$period) # to keep the ordering when plotting
```

```{r excess deaths (provinces)}
excess_deaths <- excess_deaths_provinces_data %>%
  select(!RSA) %>% # take out RSA so it's only provinces
  pivot_longer(c('EC', 'FS', 'GP', 'KZN', 'LP', 'MP', 'NC', 'NW', 'WC'), names_to = "province", values_to = "exs_deaths") %>%
  filter(!is.na(exs_deaths)) # take out NA values

# group by province and sum excess deaths to find out the total cumulative excess deaths per province
total_excess_deaths <- excess_deaths %>%
  group_by(province) %>%
  summarise_at(vars(exs_deaths), list(total_exs_deaths = sum)) %>%
  mutate(total_exs_deaths = round(total_exs_deaths)) %>%
  arrange(desc(total_exs_deaths))

# covid deaths per province
covid_deaths <- death_data %>% 
  pivot_longer(c('EC', 'FS', 'GP', 'KZN', 'LP', 'MP', 'NC', 'NW', 'WC', 'UNKNOWN'), names_to = "province", values_to = "deaths") %>% 
  select(date, province, deaths)  %>% 
  filter(province != 'UNKNOWN') %>% 
  mutate(date = dmy(date)) %>%
  filter(date == dmy("19-06-2021")) # only interested in the total covid deaths up to 19 June

# combine excess deaths with covid deaths for comparison (by province)
excess_deaths_provinces <- total_excess_deaths %>%
  inner_join(covid_deaths, by = 'province')

excess_deaths_provinces$province <- factor(excess_deaths_provinces$province, levels = excess_deaths_provinces$province) # to keep the ordering when plotting

```

```{r excess deaths (metros)}
# TODO: add covid deaths per metro for comparison

excess_deaths_metros <- excess_deahts_metros_data %>%
  mutate(date = ymd(date)) %>%
  pivot_longer(c('BUF', 'CPT', 'EKU', 'ETH', 'JHN', 'MAN', 'NMA', 'TSH'), names_to = "metro", values_to = "exs_deaths") %>%
  filter(!is.na(exs_deaths)) 

# group by metro and sum excess deaths to find out the total cumulative excess deaths per metro
total_excess_deaths_metros <- excess_deaths_metros %>%
  group_by(metro) %>%
  summarise_at(vars(exs_deaths), list(total_exs_deaths = sum)) %>%
  mutate(total_exs_deaths = round(total_exs_deaths)) %>%
  arrange(desc(total_exs_deaths))

total_excess_deaths_metros$metro <- factor(total_excess_deaths_metros$metro, levels = total_excess_deaths_metros$metro) # to keep the ordering when plotting
```

```{r continental comparison of confirmed cases}
continent_data <- continent_data %>% 
  select(date, World, Europe, North.America, South.America, Asia, Africa, Oceania) %>% 
  mutate(date = as.Date(date))

rolling_avg_continent <- continent_data %>%
  mutate(rolling_avg_world = roll_mean(World, n=7, fill = NA, align = "right")) %>% 
  mutate(rolling_avg_europe = roll_mean(Europe, n=7, fill = NA, align = "right")) %>% 
  mutate(rolling_avg_north_america = roll_mean(North.America, n=7, fill = NA, align = "right")) %>% 
  mutate(rolling_avg_south_america = roll_mean(South.America, n=7, fill = NA, align = "right")) %>% 
  mutate(rolling_avg_asia = roll_mean(Asia, n=7, fill = NA, align = "right")) %>% 
  mutate(rolling_avg_africa = roll_mean(Africa, n=7, fill = NA, align = "right")) %>% 
  mutate(rolling_avg_oceania = roll_mean(Oceania, n=7, fill = NA, align = "right"))
```

```{r private vs public tests}
# TODO: format table nicely (values and names)
tests <- testing_data %>%
  mutate(date = dmy(date)) %>%
  select(date, cumulative_tests, cumulative_tests_private, cumulative_tests_public) %>%
  mutate(daily_private=cumulative_tests_private-lag(cumulative_tests_private,default=0)) %>%
  mutate(daily_public=cumulative_tests_public-lag(cumulative_tests_public,default=0)) %>%
  filter(!is.na(cumulative_tests_private))

total_private_public <- tail(tests, 1) %>%
  mutate(total_tests = cumulative_tests, total_private_tests = cumulative_tests_private) %>%
  mutate(total_public_tests = cumulative_tests_public) %>%
  mutate(new_private = daily_private, new_public = daily_public) %>%
  select(total_tests, total_public_tests, total_private_tests, new_public, new_private) %>%
  pivot_longer(c('total_tests', 'total_public_tests', 'total_private_tests', 'new_public', 'new_private'))

total_private_public <- total_private_public %>%
  mutate(percentage = round(100*value/head(total_private_public, 1)$value, 1))

total_private_public$percentage[4] = round(100*total_private_public$value[4]/(total_private_public$value[4]+total_private_public$value[5]), 1)
total_private_public$percentage[5] = round(100*total_private_public$value[5]/(total_private_public$value[4]+total_private_public$value[5]), 1)
```

<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Plot data -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->
Row {data-width=400}
-----------------------------------------------------------------------

### confirmed cases {.value-box}

```{r plot confirmed cases box}
valueBox(
  value = paste(format(total_confirmed, big.mark = ","), " (+ ", confirmed_day_update,")", sep = ""),
  caption = "CONFIRMED CASES",
  icon = "fas fa-user-md",
  color = maroon
)
```



### total deaths {.value-box}

```{r plot total deaths box}
valueBox(
  value = paste(format(total_deaths, big.mark = ","), " (+ ", death_day_update,")", sep = ""),
  caption = "DEATHS",
  icon = "fas fa-user-md",
  color = science_red
)
```



### total tests {.value-box}

```{r plot total tests box}
valueBox(
  value = paste(format(total_tests, big.mark = ","), " (+ ", test_day_update,")", sep = ""),
  caption = "TESTS",
  icon = "fas fa-user-md",
  color = med_bluegreen
)
```

Row {data-width=400}
-------------------------------------
### active cases {.value-box}

```{r plot active cases box}
valueBox(
  value = paste(format(total_active, big.mark = ","), "", sep = " "),
  caption = "ACTIVE CASES",
  icon = "fas fa-user-md",
  color = mustard
)
```

### recovered {.value-box}

```{r plot recovered box}
valueBox(
  value = paste(format(total_recovered, big.mark = ","), " (", round(percentage_recovered, 1),"%)", sep = ""),
  caption = "RECOVERED",
  icon = "fas fa-user-md",
  color = agri_green
)
```

Row {data-width=400}
-------------------------------------
### **Daily vaccinations**
```{r}
# TODO: add vaccinations for last 7 days to side of graph
ggplot(vaccinations, aes(date, daily)) + 
  geom_col(color=agri_green) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(breaks=c(0, 50000, 100000), labels = comma, minor_breaks = NULL) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_with_light_grid()
```

### **Total vaccinations**
```{r}
ggplot(vaccinations, aes(date, total)) + 
  geom_line(color=agri_green, size=1) +
  scale_y_continuous(labels = comma, minor_breaks = NULL) +
  scale_x_date(date_breaks = "1 month", date_labels = "%d/%m") +
  geom_text(aes(label = total), data = tail(vaccinations, 1), nudge_y = 100000) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_line_light_grid()
```

Row {data-width=data_width_standard}
-------------------------------------
### **Daily confirmed cases**
```{r fig.width=10, fig.height=6}
# TODO: Format legend better

# lockdown level colours
# level_colours <- c("Level 1"="#bcbef5","Level 2"="#999ad1", "Level 3"= "#7476b5", "Level 4"="#444687", "Level 5"="#1e206e")
level_colours <- c("Level 1"=engineering_yellow,"Level 2"=arts_orange, "Level 3"= military_salmon, "Level 4"=science_red, "Level 5"=law_winered)

# plot
ggplot(confirmed_summary, aes(date)) +
  # lockdown segments
  geom_segment(data = segment1,
          aes(x = time, xend = time,
              y = 0, yend = Inf),
            show.legend = TRUE, colour=level_colours["Level 5"]) +
  geom_segment(data = segment2,
          aes(x = time, xend = time,
              y = 0, yend = Inf),
            show.legend = FALSE, colour=level_colours["Level 4"]) +
  geom_segment(data = segment3,
        aes(x = time, xend = time,
            y = 0, yend = Inf),
          show.legend = FALSE, colour=level_colours["Level 3"]) +
  geom_segment(data = segment4,
        aes(x = time, xend = time,
            y = 0, yend = Inf),
          show.legend = FALSE, colour=level_colours["Level 2"]) +
  geom_segment(data = segment5,
        aes(x = time, xend = time,
            y = 0, yend = Inf),
          show.legend = FALSE, colour=level_colours["Level 1"]) +
  geom_segment(data = segment6,
        aes(x = time, xend = time,
            y = 0, yend = Inf),
          show.legend = FALSE, colour=level_colours["Level 3"]) +
  geom_segment(data = segment7,
        aes(x = time, xend = time,
            y = 0, yend = Inf),
          show.legend = FALSE, colour=level_colours["Level 1"]) +
  geom_segment(data = segment8,
        aes(x = time, xend = time,
            y = 0, yend = Inf),
          show.legend = FALSE, colour=level_colours["Level 2"]) +
  geom_segment(data = segment9,
      aes(x = time, xend = time,
          y = 0, yend = Inf),
        show.legend = FALSE, colour=level_colours["Level 3"]) +
  # active cases and rolling average
  geom_col(aes(y = daily_confirmed), color = maroon) +
  geom_line(aes(y = rolling_avg), color = ems_lightblue, size=1) +
  labs(subtitle= "This chart shows the daily confirmed cases since March 2020. The levels refer to the lockdown levels. Blue line is the 7-day rolling average.",
     caption = "Updated: June 2021",
     x = NULL,
     y = NULL) +
  scale_colour_manual(name="Lockdown levels",values=level_colours) +
  # scale_fill_manual(name="Lockdown Levels", values=level_colours) + # manual legend
  scale_x_date(date_breaks = "1 month", date_labels = "%d %b") +
  scale_y_continuous(label=comma) +
  theme_minimal()
```


Row {data-width=data_width_standard}
-------------------------------------
### **Active case total by day**
```{r}
#TODO: Gap in active cases
ggplot(active_confirmed_summary, aes(date, total_active)) + 
  geom_col(color=arts_orange) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(label=comma, breaks = seq(0, 250000, by = 100000)) +
  custom_theme()
```


<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Daily deaths**
```{r}
ticks <- seq(as.Date("2020-04-01"), by="month", len=15)
ggplot(deaths_summary, aes(date, daily_deaths)) + 
  geom_col(fill = law_winered, color = law_winered) +
  scale_x_date(breaks = ticks, labels = paste("1", month(ticks, label = TRUE)), minor_breaks = NULL) + 
  scale_y_continuous(minor_breaks = NULL) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_theme() +
  theme(panel.grid.major.x = element_blank())

```

Row {data-width=data_width_standard}
-------------------------------------
### **Daily case trends**
```{r fig.height=4, fig.width=12}
ggplot(cases_last_8_mths, aes(date, rolling_avg)) + 
  geom_line(color = theology_purple) + 
  scale_y_continuous(labels = NULL, breaks = NULL) +
  scale_x_date(date_breaks = "2 months", date_labels = "%b") +
  facet_wrap(~ province, nrow = 2) +
  labs(subtitle= "UPDATED These charts show the seven-day average of daily new cases for the past eight months. The seven-day average is used to even out spikes in daily cases.",
       x = NULL,
       y = NULL) +
  custom_theme()
```


Row {data-width=data_width_standard}
-------------------------------------
### **Cases vs Active Cases**
```{r fig.width=8}
# TODO: add total active and total confirmed number label
# TODO: Add legend with right colours labelling active and confirmed
# TODO: Gap in active cases
ggplot(active_confirmed_summary, aes(date)) + 
  geom_line(aes(y = total_confirmed), color=theology_purple) +
  geom_line(aes(y = total_active), color=arts_orange) + 
  labs(x = NULL,
     y = NULL,
     caption = "Updated: June 2021") +
  scale_colour_manual(name="",values="level_colours") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(label=comma) +
  custom_line_theme()
```

<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Total Deaths**
<!-- TODO insert here -->

<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Doubling Rates**
<!-- TODO insert here -->

Row {data-width=data_width_standard}
-------------------------------------
### **Deaths by Province**
```{r fig.height=6}
ggplot(total_deaths_province, aes(province, deaths)) + 
  geom_col(fill = law_winered) +
  geom_text(aes(label = deaths), vjust = -1) +
  scale_x_discrete() +
  scale_y_continuous(labels = NULL, breaks = NULL) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_theme() +
  theme(panel.grid.major.x = element_blank())
```


<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Deaths by Province (per 100k)**
```{r fig.height=6}
ggplot(total_deaths_100k, aes(code, deaths_per_100k)) + 
  geom_col(fill = law_winered) +
  geom_text(aes(label = deaths_per_100k), vjust = -1) +
  scale_x_discrete() +
  scale_y_continuous(labels = NULL, breaks = NULL) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_theme() +
  theme(panel.grid.major.x = element_blank())
```


<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Prov Infections per 100,000 Population**
```{r fig.width=14}
ggplot(total_cases_100k, aes(province, cases_per_100k)) + 
  geom_col(fill = theology_purple) +
  geom_text(aes(label = format(cases_per_100k, big.mark=",")), hjust = 0) +
  scale_x_discrete() +
  scale_y_continuous(labels = NULL) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  coord_flip() +
  custom_theme() +
  theme(panel.grid = element_blank())
```


Row {data-width=data_width_standard}
-------------------------------------
### **Confirmed and Active Cases by Province**
```{r fig.width=9}
# TODO: Add labels (total active and confirmed per province)
# TODO: Convert province codes to nice province names
ggplot(provincial_active, aes(date)) + 
  geom_line(aes(y = cases, colour = "Confirmed Cases"), color = theology_purple) + 
  geom_line(aes(y = active, colour = "Active Cases"), color = arts_orange) +
  scale_y_continuous(breaks = seq(0, 1000000, by = 1000000), limits = c(0, 5000000), labels = NULL) +
  scale_x_date(labels = NULL) +
  facet_wrap(~ province, nrow = 2) +
  labs(caption = "Updated: June 2021",
     x = NULL,
     y = NULL) +
  custom_line_theme()
```

Row {data-width=data_width_standard}
-------------------------------------
### **Average daily tests per week**
```{r fig.width = 10, fig.height=12}
# TODO: reverse dates, add labels and fix sizing

ggplot(testing_avg, aes(x = rev(date), rolling_avg)) + 
  geom_col(fill = med_bluegreen) +
  labs(caption = "Updated: June 2021",
       x = "Week",
       y = NULL) +
  geom_text(aes(label = rolling_avg), hjust = 0) +
  scale_x_date(labels = NULL, breaks = NULL) +
  coord_flip() +  
  custom_theme() +
  theme(panel.grid = element_blank())
```

<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Average daily positives per week**
```{r fig.width = 10, fig.height=12}
# TODO: reverse dates, add labels and fix sizing

ggplot(weekly_avg_daily_cases, aes(rev(date), rolling_avg)) +
  geom_col(fill = theology_purple) +
  labs(caption = "Updated: June 2021",
       x = "Week",
       y = NULL) +
  geom_text(aes(label = rolling_avg), hjust = 0) +
  scale_x_date(labels = NULL) +
  coord_flip() +  
  theme_minimal() +
  theme(panel.grid = element_blank())
```

<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **No of tests per positive case (weekly)**
```{r fig.width = 10, fig.height=12}
ggplot(tests_per_positive, aes(rev(date), ratio)) +
  geom_col() +
  labs(caption = "Updated: June 2021",
       x = "Week",
       y = NULL) +
  geom_text(aes(label = round(ratio, 2)), hjust = 0) +
  scale_x_date(labels = NULL) +
  coord_flip() +
  custom_theme() +
  theme(panel.grid = element_blank())
```


Row {data-width=data_width_standard}
-------------------------------------
### **Daily tests and positive cases**
```{r fig.width = 8}
# TODO: Add number of test labels on specific dates
# TODO: Y axis labeling (cap at 60k, but allow graph to continue upward)
ggplot(bubble_data, aes(x=date, y=new_tests, size = new_cases)) +
    geom_point(alpha=0.5, color=theology_purple) +
    scale_size(range = c(.1, 10)) +
    scale_x_date(date_breaks = "1 month", date_labels = "%d/%m") +
    scale_y_continuous(label=comma) +
    labs(title = "Number of tests per day",
         x = NULL, 
         y = NULL, 
         caption = element_text("Updated: June 2021")) +
    custom_with_light_grid()
```

Row {data-width=data_width_standard}
-------------------------------------
### **Confirmed infections (last 20 days)**
```{r fig.width=15}
# TODO: not plotting right (even when flipping the dates here - the date labels are wrong)
# TODO: theology_purple colour not showing
ggplot(confirmed_20, aes(x=rev(date), y=new_cases, fill=theology_purple)) + 
  geom_col(position="dodge", color=theology_purple) +
  geom_text(aes(label = new_cases), position = position_dodge(0.9), hjust=-0.1) + # add labels
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  scale_x_date(date_breaks = "1 day", date_labels = "%m-%d-%Y") +
  scale_y_continuous(labels = NULL, breaks = NULL)  + # remove unnecessary ticks
  coord_flip() +
  custom_theme()
```

Row {data-width=data_width_standard}
-------------------------------------
### **Positivity Rate: Number of Tests vs Positive Cases (%)**
<!-- TODO insert here -->

Row {data-width=data_width_standard}
-------------------------------------
### **National Hospital Admissions**
```{r fig.width=8}
# TODO: Add EPI week x axis label
# TODO: Flip Date x axis label to be at the top
ggplot(national_hospital_data, aes(week_start, total_national_hospital_admissions)) + 
  geom_line(color=med_bluegreen, size=1) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  # scale_x_date(date_breaks = "3 months", date_labels = "%b %Y") +
  coord_cartesian(ylim = c(0, 20000)) +
  scale_x_date(date_breaks = "2 months", date_labels = "%d %b") +
  scale_y_continuous(label=comma) +
  # theme(panel.grid.major.y = element_line(colour = "lightgrey")) + custom_theme()
  custom_with_light_grid()
```

<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Public vs. Private Tests**
```{r plot private vs public tests}
  g <- tableGrob(total_private_public, rows = NULL)
  # add table borders
  g <- gtable_add_grob(g,
          grobs = rectGrob(gp = gpar(fill = NA, lwd = 2)),
          t = 2, b = nrow(g), l = 1, r = ncol(g))
  g <- gtable_add_grob(g,
          grobs = rectGrob(gp = gpar(fill = NA, lwd = 2)),
          t = 1, l = 1, r = ncol(g))
  # plot
  grid.arrange(g)
```


Row {data-width=data_width_standard}
-------------------------------------
### **Current Rt estimates for South Africa**
```{r}
# TODO: add 90% credible interval
# TODO; add current Rt value label
ggplot(rt_summary, aes(date, rolling_avg)) + 
  geom_line(color=maroon, size=1) +
  labs(subtitle= "Visit reproduction.live for detailed Rt estimates",
       caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %Y") +
  scale_y_continuous(labels = scales::number_format(accuracy = 0.1), breaks = seq(0, 3, by = 0.5)) +
  coord_cartesian(ylim = c(0, 3)) +
  custom_with_light_grid()
```

Row {data-width=data_width_standard}
-------------------------------------
### **Excess Deaths (South Africa)**
```{r}
ggplot() + 
  geom_col(deaths_SA, mapping = aes(period, total_deaths)) +
  geom_col(deaths_SA, mapping = aes(period, covid_deaths), fill = law_winered) +
  geom_text(aes(x=period, y = deaths_SA$total_deaths, 
                label=format(deaths_SA$total_deaths, big.mark = ",")), vjust=-1) +
  geom_text(aes(x=period, y = deaths_SA$covid_deaths, 
                label=format(deaths_SA$covid_deaths, big.mark = ",")), vjust=7) +
  scale_y_continuous(breaks = c(0, 100000, 200000), labels = comma, limits = c(0, 200000)) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_theme() +
  theme(panel.grid.major.x = element_blank())
```


<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Excess Deaths (Provinces)**
```{r fig.height=6}
ggplot() + 
  geom_col(excess_deaths_provinces, mapping = aes(province, total_exs_deaths)) +
  geom_col(excess_deaths_provinces, mapping = aes(province, deaths), fill = law_winered) +
  geom_text(aes(x=excess_deaths_provinces$province, y = excess_deaths_provinces$total_exs_deaths, 
                label=format(excess_deaths_provinces$total_exs_deaths, big.mark = ",")), vjust=-1) +
  scale_x_discrete() +
  scale_y_continuous(breaks = c(0, 20000, 40000), labels = comma) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_theme() +
  theme(panel.grid.major.x = element_blank())
```



<!-- Row {data-width=data_width_standard} -->
<!-- ------------------------------------- -->
### **Excess Deaths (Metros)**
```{r}
ggplot() + 
  geom_col(total_excess_deaths_metros, mapping = aes(metro, total_exs_deaths)) +
  geom_text(aes(x=total_excess_deaths_metros$metro, y = total_excess_deaths_metros$total_exs_deaths, 
                label=format(total_excess_deaths_metros$total_exs_deaths, big.mark = ",")), vjust=-1) +
  scale_x_discrete() +
  scale_y_continuous(breaks = seq(0, 15000, by = 5000), limits = c(0, 15000), labels = comma) +
  labs(caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  custom_theme() +
  theme(panel.grid.major.x = element_blank())
```


Row {data-width=data_width_standard}
-------------------------------------
### **New daily confirmed Covid-19 cases: 7-day average**

```{r fig.width=9}
ggplot(rolling_avg_continent, aes(date)) + 
  geom_line(aes(y = rolling_avg_world, colour = "World")) +
  geom_line(aes(y = rolling_avg_europe, colour = "Europe")) +
  geom_line(aes(y = rolling_avg_north_america, colour = "North America")) +
  geom_line(aes(y = rolling_avg_south_america, colour = "South America")) +
  geom_line(aes(y = rolling_avg_asia, colour = "Asia")) +
  geom_line(aes(y = rolling_avg_africa, colour = "Africa")) +
  geom_line(aes(y = rolling_avg_oceania, colour = "Oceania")) +
  labs(caption = "Updated: June 2021",
     x = NULL,
     y = NULL) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  scale_y_continuous(labels = scales::number_format(accuracy = NULL)) +
  scale_color_manual(values = c(med_bluegreen, arts_orange, mustard, theology_purple, education_darkblue, agri_green, law_winered)) +
  custom_line_light_grid()
```


Row {data-width=200}
-------------------------------------
If you have any comments, suggestions or ideas, please feel free to contact us: ginalamp@sun.ac.za or 22098038@sun.ac.za


<!----------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- Other non-code stuff -->
<!----------------------------------------------------------------------------------------------------------------------------------------------------->
# Project Writeup

### Overview
The purpose of this project was to recreate the [Mediahack Coronavirus in South Africa](https://mediahack.co.za/datastories/coronavirus/dashboard/) dashboard using R programming language.

**Process**

Our first point of action was to gather the data. For this, we needed to ask some important questions such as "What data is needed?", "Where do we get the data?", "What format do we need the data", and "How much data do we need?".

After understanding our initial problem, we went ahead and gathered as much of our needed data as we could. We divided the graph's amongst the two of us using an online spreadsheet (allowing for self-allocation and process tracking), and used a GitHub repo for version control.


#### Extra features
* We used [Stellenbosch University's Branding Manual](http://stbweb01.stb.sun.ac.za/centenarybrandtoolkit/SU_Brand_Manual_2019.pdf) to generate the colours used in this dashboard.
* We used the [flexdashboard](https://pkgs.rstudio.com/flexdashboard/) format to beautifully arange our graphs in a real dashboard-like manner.

### Reflection

**Challenges**

1. We struggled with replicating the Doubling Rates graph for the Confirmed cases and Deaths. We used [this](http://njcmindia.org/uploads/11-3_141-143.pdf) resource (amongst others) to understand Doubling Rates, but our graph came out quite differently to the one on the [dashboard](https://mediahack.co.za/datastories/coronavirus/dashboard/) we tried to replicate. 
2. When creating two graphs with different x-axis scales (Positivity rate and Total deaths), we were only able to generate pdf's with the correct graph as we needed to combine different scales for the x-axis.
3. For the lockdown levels we struggled with adding a matching legend.
4. We couldn't find South African metropolitan population data, and as such were not able to implement the excess mortality in South African metros.

**Learned**

This project catalyzed a lot of learning. It is one thing to theoretically know what to do, and another to put it into practice. We learned a lot about data wrangling and ways to visualise what we wish to communicate. It was also a good lesson to really see the 80-20 principle come into play when it comes to the time spent gathering, cleaning, and wrangling data in comparison to actually plotting it.

The theme of the project is very relevant and appropriate, so we learned about the current state of the pandemic in our country. It also gave us additional insight into what certain terms mean, such as the doubling rate, and excess mortality.

**If we had more time...**

Some features that we would've liked to add include:

1. Having reactive graphs (instead of static images)
2. Further tackle the challenges that we were facing (doubling rates, pdf generation, lockdown legend, South African metro excess deaths)

# Sources
**Main data sources:**

* [rt South Africa](https://github.com/dsfsi/covid19za/blob/master/data/calc/calculated_rt_sa_provincial_cumulative.csv)
* [Global hospital admissions JSON](https://github.com/owid/covid-19-data/blob/master/public/data/internal/megafile--hospital-admissions.json)
* [Global github repo](https://github.com/owid/covid-19-data/tree/master/public/data)
* [South African github repo - most current sources](https://github.com/dsfsi/covid19za)
* [South Africa bunch of data](https://ourworldindata.org/coronavirus/country/south-africa) 
* [Covid Lockdown Levels as text - might need scraping](https://www.gov.za/covid-19/about/about-alert-system)
* [Population per city - needs admin_name grouping and summing](https://simplemaps.com/data/za-cities)

**Some helpful formatting sources:**

* [Flexdashboard](https://pkgs.rstudio.com/flexdashboard/) - [Basic Row and Cols](https://blog.      rstudio.com/2016/05/17/flexdashboard-easy-interactive-dashboards-for-r/)
* [General good resource](http://zevross.com/blog/2014/08/04/beautiful-plotting-in-r-a-ggplot2-      cheatsheet-3/)
* [Add commas to y-axis labels](https://stackoverflow.com/questions/37713351/formatting-ggplot2-     axis-labels-with-commas-and-k-mm-if-i-already-have-a-y-sc)
* [Set y axis breaks](https://stackoverflow.com/questions/22818899/setting-y-axis-breaks-in-ggplot)
* [Add specific date labels](https://www.r-graph-gallery.com/279-plotting-time-series-with-ggplot2.  html)
* [Decimal formatting with scales library](https://scales.r-lib.org/reference/number_format.html)
* [Set x/y axis cartesian limits](https://ggplot2.tidyverse.org/reference/lims.html)
* [Create manual legend](https://stackoverflow.com/questions/17148679/construct-a-manual-legend-for- a-complicated-plot)



