---
title: "R Notebook"
output: html_notebook
---

```{r Setup}
library(tidyverse)
library(lubridate)
```

```{r Data: Confirmed Cases}
data <- read.csv("data/covid19za_provincial_cumulative_timeline_confirmed.csv")
head(data)
```
```{r Tidy data}
cases <- data %>% pivot_longer(c('EC', 'FS', 'GP', 'KZN', 'LP', 'MP', 'NC', 'NW', 'WC', 'UNKNOWN'), names_to = "province", values_to = "cases")
cases <- cases %>% 
  select(date, province, cases, total)  %>% 
  filter(province != 'UNKNOWN')
cases <- cases %>% mutate(date = dmy(date))

head(cases)
```


```{r Plot}
ggplot(cases, aes(date, cases)) + 
  geom_smooth(color = "blue") + 
  scale_y_continuous(breaks = seq(0, 1000000, by = 100000), limits = c(0, 1000000), labels = NULL) +
  scale_x_date(labels = NULL) +
  facet_wrap(~ province, nrow = 2) +
  theme_minimal() +
  labs(title= "Confirmed Cases by Province",
       x = NULL,
       y = NULL)

```
```{r}
library(RcppRoll)

cases <- cases %>%
  group_by(province) %>%
  mutate(daily_cases=cases-lag(cases,default=0)) %>%
  mutate(rolling_avg = roll_mean(daily_cases, n=7, fill = NA, align = "right"))

cases_last_8_mths <- cases %>%
  filter(date >= ymd("2020-11-12"))

ggplot(cases_last_8_mths, aes(date, rolling_avg)) + 
  geom_point(color = "blue") + 
  scale_y_continuous(labels = NULL) +
  scale_x_date(labels = NULL) +
  facet_wrap(~ province, nrow = 2) +
  theme_minimal() +
  labs(title= "Daily Case Trends per Province",
       x = NULL,
       y = NULL)
```
```{r}
province_population <- read.csv("data/province_population.csv")
province_population

total_cases <- tail(cases, 9) # cumulative cases per province up to 21 June 2021
total_cases <- total_cases %>%
  ungroup() %>%
  mutate(code = province) %>%
  select(code, cases) %>%
  left_join(province_population, by = "code") %>% # add province populations to province cases
  select(code, province, cases, population) %>%
  mutate(cases_per_100k = round(100000 * cases / population)) # calculate infections per 100k population
  
total_cases
```
```{r plot deaths by province per 100k}
ggplot(total_cases, aes(province, cases_per_100k)) + 
  geom_col() +
  geom_text(aes(label = cases_per_100k), hjust = 0) +
  scale_x_discrete() +
  scale_y_continuous(labels = NULL) +
  labs(title= "Prov Infections per 100,000 Population",
       caption = "Updated: June 2021",
       x = NULL,
       y = NULL) +
  coord_flip() +
  theme_minimal()
```

